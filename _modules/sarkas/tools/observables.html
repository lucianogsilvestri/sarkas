  <!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sarkas.tools.observables &#8212; Sarkas 0.1.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" />
    <link rel="stylesheet" type="text/css" href="../../../_static/my-style.css" />
    <link rel="stylesheet" href="../../../_static/my-styles.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/myscript.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
  
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html"><span><img src="../../../_static/logo_s_orange.png"></span>
          ARKAS</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../documentation/get_started.html">Get Started</a></li>
                <li><a href="../../../examples/examples.html">Examples</a></li>
                <li><a href="../../../code%20development/code_dev.html">Code Development</a></li>
                <li><a href="../../../api/api.html">API</a></li>
                <li><a href="../../../credits/credits.html">Credits</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation/why_sarkas.html">Why Sarkas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation/get_started.html">Get Started</a></li>
</ul>
<p class="caption"><span class="caption-text">Theory:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../theory/theory.html">Theoretical Background</a></li>
</ul>
<p class="caption"><span class="caption-text">Code Dev:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../code%20development/code_dev.html">Code Development</a></li>
</ul>
<p class="caption"><span class="caption-text">Simulations:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/examples.html">Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Credits:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../credits/credits.html">Credits</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for sarkas.tools.observables</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for calculating physical quantities from Sarkas checkpoints.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">get_ipython</span>

<span class="k">if</span> <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;ZMQInteractiveShell&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm_notebook</span> <span class="k">as</span> <span class="n">tqdm</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1"># import h5py</span>
<span class="c1"># import logging</span>

<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">scp_signal</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">scp_stats</span>

<span class="kn">from</span> <span class="nn">sarkas.utilities.timing</span> <span class="kn">import</span> <span class="n">SarkasTimer</span>
<span class="kn">from</span> <span class="nn">sarkas.utilities.io</span> <span class="kn">import</span> <span class="n">num_sort</span>

<span class="n">UNITS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># MKS Units</span>
    <span class="p">{</span><span class="s2">&quot;Energy&quot;</span><span class="p">:</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Time&quot;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Length&quot;</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Charge&quot;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Temperature&quot;</span><span class="p">:</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span>
     <span class="s2">&quot;ElectronVolt&quot;</span><span class="p">:</span> <span class="s1">&#39;eV&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Mass&quot;</span><span class="p">:</span> <span class="s1">&#39;kg&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Magnetic Field&quot;</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Current&quot;</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span>
     <span class="s2">&quot;Power&quot;</span><span class="p">:</span> <span class="s2">&quot;erg/s&quot;</span><span class="p">,</span>
     <span class="s2">&quot;Pressure&quot;</span><span class="p">:</span> <span class="s2">&quot;Pa&quot;</span><span class="p">,</span>
     <span class="s2">&quot;Conductivity&quot;</span><span class="p">:</span> <span class="s2">&quot;S/m&quot;</span><span class="p">,</span>
     <span class="s2">&quot;Diffusion&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;m$^2$/s&quot;</span><span class="p">,</span>
     <span class="s2">&quot;Viscosity&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;Pa s&quot;</span><span class="p">,</span>
     <span class="s2">&quot;none&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span>
    <span class="c1"># CGS Units</span>
    <span class="p">{</span><span class="s2">&quot;Energy&quot;</span><span class="p">:</span> <span class="s1">&#39;erg&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Time&quot;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Length&quot;</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Charge&quot;</span><span class="p">:</span> <span class="s1">&#39;esu&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Temperature&quot;</span><span class="p">:</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span>
     <span class="s2">&quot;ElectronVolt&quot;</span><span class="p">:</span> <span class="s1">&#39;eV&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Mass&quot;</span><span class="p">:</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Magnetic Field&quot;</span><span class="p">:</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span>
     <span class="s2">&quot;Current&quot;</span><span class="p">:</span> <span class="s2">&quot;esu/s&quot;</span><span class="p">,</span>
     <span class="s2">&quot;Power&quot;</span><span class="p">:</span> <span class="s2">&quot;erg/s&quot;</span><span class="p">,</span>
     <span class="s2">&quot;Pressure&quot;</span><span class="p">:</span> <span class="s2">&quot;Ba&quot;</span><span class="p">,</span>
     <span class="s2">&quot;Conductivity&quot;</span><span class="p">:</span> <span class="s2">&quot;mho/m&quot;</span><span class="p">,</span>
     <span class="s2">&quot;Diffusion&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;m$^2$/s&quot;</span><span class="p">,</span>
     <span class="s2">&quot;Viscosity&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;Ba s&quot;</span><span class="p">,</span>
     <span class="s2">&quot;none&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
<span class="p">]</span>

<span class="n">PREFIXES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">1.0e-24</span><span class="p">,</span>  <span class="c1"># yocto</span>
    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mf">1.0e-21</span><span class="p">,</span>  <span class="c1"># zepto</span>
    <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mf">1.0e-18</span><span class="p">,</span>  <span class="c1"># atto</span>
    <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="mf">1.0e-15</span><span class="p">,</span>  <span class="c1"># femto</span>
    <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="mf">1.0e-12</span><span class="p">,</span>  <span class="c1"># pico</span>
    <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="mf">1.0e-9</span><span class="p">,</span>  <span class="c1"># nano</span>
    <span class="sa">r</span><span class="s2">&quot;$\mu$&quot;</span><span class="p">:</span> <span class="mf">1.0e-6</span><span class="p">,</span>  <span class="c1"># micro</span>
    <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="mf">1.0e-3</span><span class="p">,</span>  <span class="c1"># milli</span>
    <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mf">1.0e-2</span><span class="p">,</span>  <span class="c1"># centi</span>
    <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span>  <span class="c1"># kilo</span>
    <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="mf">1e6</span><span class="p">,</span>  <span class="c1"># mega</span>
    <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="mf">1e9</span><span class="p">,</span>  <span class="c1"># giga</span>
    <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="mf">1e12</span><span class="p">,</span>  <span class="c1"># tera</span>
    <span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="mf">1e15</span><span class="p">,</span>  <span class="c1"># peta</span>
    <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="mf">1e18</span><span class="p">,</span>  <span class="c1"># exa</span>
    <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="mf">1e21</span><span class="p">,</span>  <span class="c1"># zetta</span>
    <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="mf">1e24</span>  <span class="c1"># yotta</span>
<span class="p">}</span>


<div class="viewcode-block" id="Observable"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Observable">[docs]</a><span class="k">class</span> <span class="nc">Observable</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parent class of all the observables.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    dataframe : pandas.DataFrame</span>
<span class="sd">        Dataframe containing the computed data.</span>

<span class="sd">    dataframe_longitudinal : pandas.DataFrame</span>
<span class="sd">        Dataframe containing the longitudinal part of the computed observable.</span>

<span class="sd">    dataframe_transverse : pandas.DataFrame</span>
<span class="sd">        Dataframe containing the transverse part of the computed observable.</span>

<span class="sd">    max_k_harmonics : list</span>
<span class="sd">        Maximum number of :math:`\mathbf{k}` harmonics to calculatealong each dimension.</span>

<span class="sd">    phase : str</span>
<span class="sd">        Phase to analyze.</span>

<span class="sd">    prod_no_dumps : int</span>
<span class="sd">        Number of production phase checkpoints. Calculated from the number of files in the Production directory.</span>

<span class="sd">    eq_no_dumps : int</span>
<span class="sd">        Number of equilibration phase checkpoints. Calculated from the number of files in the Equilibration directory.</span>

<span class="sd">    no_dumps : int</span>
<span class="sd">        Number of simulation&#39;s checkpoints. Calculated from the number of files in the phase folder.</span>

<span class="sd">    dump_dir : str</span>
<span class="sd">        Path to correct dump directory.</span>

<span class="sd">    dump_step : int</span>
<span class="sd">        Correct step interval.</span>
<span class="sd">        It is either ``sarkas.base.Parameters.prod_dump_step`` or ``sarkas.base.Parameters.eq_dump_step``.</span>

<span class="sd">    no_obs : int</span>
<span class="sd">        Number of independent binary observable quantities.</span>
<span class="sd">        It is calculated as :math:`N_s (N_s + 1) / 2` where :math: `N_s` is the number of species.</span>

<span class="sd">    k_file : str</span>
<span class="sd">        Path to the npz file storing the :math:`k` vector values.</span>

<span class="sd">    nkt_hdf_file : str</span>
<span class="sd">        Path to the npy file containing the Fourier transform of density fluctuations. :math:`n(\mathbf k, t)`.</span>

<span class="sd">    vkt_file : str</span>
<span class="sd">        Path to the npz file containing the Fourier transform of velocity fluctuations. :math:`\mathbf v(\mathbf k, t)`.</span>

<span class="sd">    k_space_dir : str</span>
<span class="sd">        Directory where :math:`\mathbf {k}` data is stored.</span>

<span class="sd">    filename_csv_longitudinal : str</span>
<span class="sd">        Path to to the csv file containing the longitudinal part of the computed observable.</span>

<span class="sd">    filename_csv_transverse : str</span>
<span class="sd">        Path to the csv file containing the transverse part of the computed observable.</span>

<span class="sd">    saving_dir : str</span>
<span class="sd">        Path to the directory where computed data is stored.</span>

<span class="sd">    dimensional_average: bool</span>
<span class="sd">            Flag for averaging over all dimensions. Default = False.</span>

<span class="sd">    runs: int</span>
<span class="sd">            Number of independent MD runs. Default = 1.</span>

<span class="sd">    multi_run_average: bool</span>
<span class="sd">        Flag for averaging over multiple runs. Default = False.</span>
<span class="sd">        If True, `runs` needs be specified. It will collect data from all runs and stored them in a large ndarray to</span>
<span class="sd">        be averaged over.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;production&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_run_average</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimensional_average</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runs</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen_output</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">SarkasTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_observable</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sortedDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
        <span class="n">disp</span> <span class="o">=</span> <span class="s1">&#39;Observable( &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sortedDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dataframe&#39;</span><span class="p">,</span> <span class="s1">&#39;dataframe_longitudinal&#39;</span><span class="p">,</span> <span class="s1">&#39;dataframe_transverse&#39;</span><span class="p">]:</span>
                <span class="n">disp</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">disp</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">return</span> <span class="n">disp</span>

<div class="viewcode-block" id="Observable.from_dict"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Observable.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update attributes from input dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_dict: dict</span>
<span class="sd">            Dictionary to be copied.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Observable.setup_init"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Observable.setup_init">[docs]</a>    <span class="k">def</span> <span class="nf">setup_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign Observables attributes and copy the simulation&#39;s parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : sarkas.base.Parameters</span>
<span class="sd">            Simulation&#39;s Parameters.</span>

<span class="sd">        phase : str</span>
<span class="sd">            Phase to compute.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_observable</span><span class="p">:</span>
            <span class="c1"># Check for k space information.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;angle_averaging&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">=</span> <span class="s1">&#39;principal_axis&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;max_aa_ka_value&#39;</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span><span class="p">,</span> <span class="s1">&#39;max_aa_harmonics and max_aa_ka_value not defined.&#39;</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;max_aa_harmonics&#39;</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span><span class="p">,</span> <span class="s1">&#39;max_aa_harmonics and max_aa_ka_value not defined.&#39;</span>

            <span class="c1"># More checks on k attributes and initialization of k vectors</span>

            <span class="c1"># Dev Notes:</span>
            <span class="c1">#           Make sure that max_k_harmonics and max_aa_harmonics are defined once this if is done.</span>
            <span class="c1">#           The user can either define max_k_harmonics or max_ka_value</span>
            <span class="c1">#           Based on this choice the user can define max_aa_harmonics or max_aa_ka_value</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;max_k_harmonics&#39;</span><span class="p">):</span>
                <span class="c1"># Convert max_k_harmonics to a numpy array</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span>

                <span class="c1"># Calculate max_aa_harmonics based on the choice of angle averaging and inputs</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
                    <span class="c1"># Check if the user has defined the max_aa_harmonics</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span><span class="p">:</span>
                        <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">])</span>
                    <span class="c1"># else max_aa_harmonics is user defined</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;principal_axis&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;max_ka_value&#39;</span><span class="p">):</span>
                <span class="c1"># Calculate max_k_harmonics from max_ka_value</span>

                <span class="c1"># Check for angle_averaging choice</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
                    <span class="c1"># The maximum value is calculated assuming that max nx = max ny = max nz</span>
                    <span class="c1"># ka_max = 2pi a/L sqrt( nx^2 + ny^2 + nz^2) = 2pi a/L nx sqrt(3)</span>
                    <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">])</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
                    <span class="c1"># ka_max = 2pi a/L sqrt( nx^2 + 0 + 0) = 2pi a/L nx</span>
                    <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">])</span>
                    <span class="c1"># Check if the user has defined the max_aa_harmonics</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span><span class="p">:</span>
                        <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">])</span>
                    <span class="c1"># else max_aa_harmonics is user defined</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;principal_axis&#39;</span><span class="p">:</span>
                    <span class="c1"># ka_max = 2pi a/L sqrt( nx^2 + 0 + 0) = 2pi a/L nx</span>
                    <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Executive decision</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">=</span> <span class="s1">&#39;principal_axis&#39;</span>

            <span class="c1"># Calculate the maximum ka value based on user&#39;s choice of angle_averaging</span>
            <span class="c1"># Dev notes: Make sure max_ka_value, max_aa_ka_value are defined when this if is done</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;principal_axis&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Create paths for files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_space_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postprocessing_dir</span><span class="p">,</span> <span class="s2">&quot;k_space_data&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_space_dir</span><span class="p">,</span> <span class="s2">&quot;k_arrays.npz&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nkt_hdf_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_space_dir</span><span class="p">,</span> <span class="s2">&quot;nkt.h5&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vkt_hdf_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_space_dir</span><span class="p">,</span> <span class="s2">&quot;vkt.h5&quot;</span><span class="p">)</span>

        <span class="c1"># Get the number of independent observables if multi-species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_obs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Get the total number of dumps by looking at the files in the directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prod_no_dumps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prod_dump_dir</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eq_no_dumps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eq_dump_dir</span><span class="p">))</span>
        <span class="c1"># Check for magnetized plasma options</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnetized</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrostatic_equilibration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mag_no_dumps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_dump_dir</span><span class="p">))</span>

        <span class="c1"># Assign dumps variables based on the choice of phase</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;equilibration&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eq_no_dumps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eq_dump_step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_steps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eq_dump_dir</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_no_dumps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_dump_step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">production_steps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_dump_dir</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;magnetization&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_no_dumps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_dump_step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnetization_steps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_dump_dir</span>

        <span class="c1"># Time slicing for long runs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;no_slices&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">production_steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_dump_step</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">)</span>

        <span class="c1"># Array containing the start index of each species. The last value is equivalent to vel_raw.shape[-1]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_index_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span></div>

        <span class="c1"># Logger</span>
        <span class="c1"># log_file = os.path.join(self.postprocessing_dir, &#39;Logger_PostProcessing_&#39; + self.job_id + &#39;.out&#39;)</span>
        <span class="c1"># logging.basicConfig(filename=log_file,</span>
        <span class="c1">#                     filemode=&#39;a&#39;,</span>
        <span class="c1">#                     # format=&#39;%(levelname)s:%(message)s&#39;,</span>
        <span class="c1">#                     # format=&#39;%(levelname)s: %(asctime)s %(message)s&#39;, datefmt=&#39;%m/%d/%Y %I:%M:%S %p&#39;,</span>
        <span class="c1">#                     level=logging.INFO)</span>

<div class="viewcode-block" id="Observable.parse"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Observable.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Grab the pandas dataframe from the saved csv file. If file does not exist call ``compute``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;dsf&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;ccf&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">k_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_list</span> <span class="o">=</span> <span class="n">k_data</span><span class="p">[</span><span class="s2">&quot;k_list&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_counts</span> <span class="o">=</span> <span class="n">k_data</span><span class="p">[</span><span class="s2">&quot;k_counts&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span> <span class="o">=</span> <span class="n">k_data</span><span class="p">[</span><span class="s2">&quot;ka_values&quot;</span><span class="p">]</span>

            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">File </span><span class="si">{}</span><span class="s2"> not found!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Computing Observable now ...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">File </span><span class="si">{}</span><span class="s2"> not found!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Computing Observable now ...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span></div>

<div class="viewcode-block" id="Observable.parse_k_data"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Observable.parse_k_data">[docs]</a>    <span class="k">def</span> <span class="nf">parse_k_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read in the precomputed Fourier space data. Recalculate if not correct.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">k_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_file</span><span class="p">)</span>
            <span class="c1"># Check for the correct number of k values</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="n">k_data</span><span class="p">[</span><span class="s2">&quot;angle_averaging&quot;</span><span class="p">]:</span>
                <span class="c1"># Check for the correct max harmonics</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span> <span class="o">==</span> <span class="n">k_data</span><span class="p">[</span><span class="s2">&quot;max_k_harmonics&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">k_list</span> <span class="o">=</span> <span class="n">k_data</span><span class="p">[</span><span class="s2">&quot;k_list&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span> <span class="o">=</span> <span class="n">k_data</span><span class="p">[</span><span class="s2">&quot;k_harmonics&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">k_counts</span> <span class="o">=</span> <span class="n">k_data</span><span class="p">[</span><span class="s2">&quot;k_counts&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">k_values</span> <span class="o">=</span> <span class="n">k_data</span><span class="p">[</span><span class="s2">&quot;k_values&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span> <span class="o">=</span> <span class="n">k_data</span><span class="p">[</span><span class="s2">&quot;ka_values&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">no_ka_values</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calc_k_data</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_k_data</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_k_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="Observable.calc_k_data"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Observable.calc_k_data">[docs]</a>    <span class="k">def</span> <span class="nf">calc_k_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate and save Fourier space data.&quot;&quot;&quot;</span>

        <span class="c1"># Do some checks</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span><span class="p">,</span>
                          <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;angle_averaging not a string. Choose from [&#39;full&#39;, &#39;custom&#39;, &#39;principal_axis&#39;]&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s1">&#39;max_k_harmonics not defined.&#39;</span>

        <span class="c1"># Calculate the k arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_counts</span><span class="p">,</span> <span class="n">k_unique</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span> <span class="o">=</span> <span class="n">kspace_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">,</span>
                                                                              <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span><span class="p">,</span>
                                                                              <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">,</span>
                                                                              <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span><span class="p">)</span>
        <span class="c1"># Save the ka values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">k_unique</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_values</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">k_unique</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_ka_values</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">)</span>

        <span class="c1"># Check if the writing folder exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_space_dir</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_space_dir</span><span class="p">)</span>

        <span class="c1"># Write the npz file</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_file</span><span class="p">,</span>
                 <span class="n">k_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">,</span>
                 <span class="n">k_harmonics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">,</span>
                 <span class="n">k_counts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k_counts</span><span class="p">,</span>
                 <span class="n">k_values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k_values</span><span class="p">,</span>
                 <span class="n">ka_values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">,</span>
                 <span class="n">angle_averaging</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span><span class="p">,</span>
                 <span class="n">max_k_harmonics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">,</span>
                 <span class="n">max_aa_harmonics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span><span class="p">)</span></div>

<div class="viewcode-block" id="Observable.parse_kt_data"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Observable.parse_kt_data">[docs]</a>    <span class="k">def</span> <span class="nf">parse_kt_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nkt_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vkt_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read in the precomputed time dependent Fourier space data. Recalculate if not.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nkt_flag : bool</span>
<span class="sd">            Flag for reading microscopic density Fourier components ``n(\mathbf k, t)``. Default = False.</span>

<span class="sd">        vkt_flag : bool</span>
<span class="sd">            Flag for reading microscopic velocity Fourier components,``v(\mathbf k, t)``. Default = False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nkt_flag</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check that what was already calculated is correct</span>
                <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkt_hdf_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">nkt_hfile</span><span class="p">:</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">nkt_hfile</span><span class="o">.</span><span class="n">get_storer</span><span class="p">(</span><span class="s1">&#39;nkt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">metadata</span>

                <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;no_slices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">:</span>
                    <span class="c1"># Check for the correct number of k values</span>
                    <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;angle_averaging&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span><span class="p">:</span>
                        <span class="c1"># Check for the correct max harmonics</span>
                        <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span> <span class="o">==</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;max_k_harmonics&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">comp</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">calc_kt_data</span><span class="p">(</span><span class="n">nkt_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">calc_kt_data</span><span class="p">(</span><span class="n">nkt_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calc_kt_data</span><span class="p">(</span><span class="n">nkt_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># elif metadata[&#39;max_k_harmonics&#39;]</span>
                <span class="c1">#</span>
                <span class="c1"># if self.angle_averaging == nkt_data[&quot;angle_averaging&quot;]:</span>
                <span class="c1">#</span>
                <span class="c1">#     comp = self.max_k_harmonics == nkt_data[&quot;max_harmonics&quot;]</span>
                <span class="c1">#     if not comp.all():</span>
                <span class="c1">#         self.calc_kt_data(nkt_flag=True)</span>
                <span class="c1"># else:</span>
                <span class="c1">#     self.calc_kt_data(nkt_flag=True)</span>

            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_kt_data</span><span class="p">(</span><span class="n">nkt_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vkt_flag</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check that what was already calculated is correct</span>
                <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vkt_hdf_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">vkt_hfile</span><span class="p">:</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">vkt_hfile</span><span class="o">.</span><span class="n">get_storer</span><span class="p">(</span><span class="s1">&#39;vkt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">metadata</span>

                <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;no_slices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">:</span>
                    <span class="c1"># Check for the correct number of k values</span>
                    <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;angle_averaging&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span><span class="p">:</span>
                        <span class="c1"># Check for the correct max harmonics</span>
                        <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span> <span class="o">==</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;max_k_harmonics&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">comp</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">calc_kt_data</span><span class="p">(</span><span class="n">vkt_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">calc_kt_data</span><span class="p">(</span><span class="n">vkt_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calc_kt_data</span><span class="p">(</span><span class="n">vkt_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_kt_data</span><span class="p">(</span><span class="n">vkt_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Observable.calc_kt_data"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Observable.calc_kt_data">[docs]</a>    <span class="k">def</span> <span class="nf">calc_kt_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nkt_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vkt_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate Time dependent Fourier space quantities.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nkt_flag : bool</span>
<span class="sd">            Flag for calculating microscopic density Fourier components ``n(\mathbf k, t)``. Default = False.</span>

<span class="sd">        vkt_flag : bool</span>
<span class="sd">            Flag for calculating microscopic velocity Fourier components,``v(\mathbf k, t)``. Default = False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_slice</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">end_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span>
        <span class="k">if</span> <span class="n">nkt_flag</span><span class="p">:</span>
            <span class="n">nkt_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="n">tinit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating n(k,t) for slice </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">))</span>
                <span class="n">nkt</span> <span class="o">=</span> <span class="n">calc_nkt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span><span class="p">,</span>
                               <span class="p">(</span><span class="n">start_slice</span><span class="p">,</span> <span class="n">end_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">),</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">start_slice</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span>
                <span class="n">end_slice</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span>
                <span class="c1"># n(k,t).shape = [no_species, time, k vectors]</span>

                <span class="n">slc_column</span> <span class="o">=</span> <span class="s2">&quot;slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>

                    <span class="n">df_columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">slc_column</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">_k = [</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">))]</span>
                    <span class="c1"># df_columns = [time_column, *k_columns]</span>
                    <span class="n">nkt_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">nkt_dataframe</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nkt</span><span class="p">[</span><span class="n">isp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_columns</span><span class="p">)],</span>
                                              <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">tuples</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">nkt_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">nkt_dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">tuples</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;slices&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="s1">&#39;harmonics&#39;</span><span class="p">])</span>

            <span class="c1"># Sample nkt_dataframe</span>
            <span class="c1"># slices slice 1</span>
            <span class="c1"># species H</span>
            <span class="c1"># harmonics k = [0, 0, 1] | k = [0, 1, 0] | ...</span>

            <span class="c1"># Save the data and append metadata</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkt_hdf_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkt_hdf_file</span><span class="p">)</span>

            <span class="n">hfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkt_hdf_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">hfile</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;nkt&#39;</span><span class="p">,</span> <span class="n">nkt_dataframe</span><span class="p">)</span>
            <span class="c1"># This metadata is needed to check if I need to recalculate</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;no_slices&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">,</span>
                <span class="s1">&#39;max_k_harmonics&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">,</span>
                <span class="s1">&#39;angle_averaging&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span>
            <span class="p">}</span>

            <span class="n">hfile</span><span class="o">.</span><span class="n">get_storer</span><span class="p">(</span><span class="s1">&#39;nkt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
            <span class="n">hfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">(</span><span class="s2">&quot;n(k,t) Calculation&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">time_division</span><span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tinit</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">vkt_flag</span><span class="p">:</span>
            <span class="n">vkt_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="n">tinit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating longitudinal and transverse &quot;</span>
                      <span class="s2">&quot;velocity fluctuations v(k,t) for slice </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">))</span>
                <span class="n">vkt</span><span class="p">,</span> <span class="n">vkt_i</span><span class="p">,</span> <span class="n">vkt_j</span><span class="p">,</span> <span class="n">vkt_k</span> <span class="o">=</span> <span class="n">calc_vkt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span><span class="p">,</span>
                                                    <span class="p">(</span><span class="n">start_slice</span><span class="p">,</span> <span class="n">end_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">),</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">start_slice</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span>
                <span class="n">end_slice</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span>

                <span class="n">slc_column</span> <span class="o">=</span> <span class="s2">&quot;slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
                    <span class="n">df_columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">slc_column</span> <span class="o">+</span> <span class="s1">&#39;_Longitudinal_</span><span class="si">{}</span><span class="s1">_k = [</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">))]</span>
                    <span class="c1"># df_columns = [time_column, *k_columns]</span>
                    <span class="n">vkt_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">vkt_dataframe</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vkt</span><span class="p">[</span><span class="n">isp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_columns</span><span class="p">)],</span>
                                              <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">df_columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">slc_column</span> <span class="o">+</span> <span class="s1">&#39;_Transverse i_</span><span class="si">{}</span><span class="s1">_k = [</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span>
                                                                                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">))]</span>
                    <span class="n">vkt_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">vkt_dataframe</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vkt_i</span><span class="p">[</span><span class="n">isp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_columns</span><span class="p">)],</span>
                                              <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">df_columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">slc_column</span> <span class="o">+</span> <span class="s1">&#39;_Transverse j_</span><span class="si">{}</span><span class="s1">_k = [</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span>
                                                                                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">))]</span>
                    <span class="n">vkt_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">vkt_dataframe</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vkt_j</span><span class="p">[</span><span class="n">isp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_columns</span><span class="p">)],</span>
                                              <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">df_columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">slc_column</span> <span class="o">+</span> <span class="s1">&#39;_Transverse k_</span><span class="si">{}</span><span class="s1">_k = [</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span>
                                                                                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">))]</span>
                    <span class="n">vkt_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">vkt_dataframe</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vkt_k</span><span class="p">[</span><span class="n">isp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_columns</span><span class="p">)],</span>
                                              <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Full string: slice 1_Longitudinal_He_k = [1, 0, 0]</span>
            <span class="n">tuples</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">vkt_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">vkt_dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
                <span class="n">tuples</span><span class="p">,</span>
                <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;slices&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span>  <span class="s1">&#39;harmonics&#39;</span><span class="p">])</span>

            <span class="c1"># Sample nkt_dataframe</span>
            <span class="c1"># slices slice 1</span>
            <span class="c1"># species H</span>
            <span class="c1"># direction Longitudinal/Transverse</span>
            <span class="c1"># harmonics k = [0, 0, 1] | k = [0, 1, 0] | ...</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vkt_hdf_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vkt_hdf_file</span><span class="p">)</span>
            <span class="c1"># Save the data and append metadata</span>
            <span class="n">hfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vkt_hdf_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">hfile</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;vkt&#39;</span><span class="p">,</span> <span class="n">vkt_dataframe</span><span class="p">)</span>
            <span class="c1"># This metadata is needed to check if I need to recalculate</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;no_slices&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">,</span>
                <span class="s1">&#39;max_k_harmonics&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">,</span>
                <span class="s1">&#39;angle_averaging&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span>
            <span class="p">}</span>

            <span class="n">hfile</span><span class="o">.</span><span class="n">get_storer</span><span class="p">(</span><span class="s1">&#39;vkt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
            <span class="n">hfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">(</span><span class="s2">&quot;v(k,t) Calculation&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">time_division</span><span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tinit</span><span class="p">))</span></div>

                <span class="c1"># np.savez(self.vkt_file + &#39;_slice_&#39; + str(isl) + &#39;.npz&#39;,</span>
                <span class="c1">#          longitudinal=vkt,</span>
                <span class="c1">#          transverse_i=vkt_i,</span>
                <span class="c1">#          transverse_j=vkt_j,</span>
                <span class="c1">#          transverse_k=vkt_k,</span>
                <span class="c1">#          max_harmonics=self.max_k_harmonics,</span>
                <span class="c1">#          angle_averaging=self.angle_averaging)</span>

<div class="viewcode-block" id="Observable.plot"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Observable.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scaling</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">acf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the observable by calling the pandas.DataFrame.plot() function and save the figure.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hdf_column</span>
<span class="sd">        scaling : float, tuple</span>
<span class="sd">            Factor by which to rescale the x and y axis.</span>

<span class="sd">        acf : bool</span>
<span class="sd">            Flag for renormalizing the autocorrelation functions. Default= False</span>

<span class="sd">        longitudinal : bool</span>
<span class="sd">            Flag for longitudinal plot in case of CurrenCurrelationFunction. Default = True</span>

<span class="sd">        figname : str</span>
<span class="sd">            Name with which to save the file. It automatically saves it in the correct directory.</span>

<span class="sd">        show : bool</span>
<span class="sd">            Flag for prompting the plot to screen. Default=False</span>

<span class="sd">        **kwargs :</span>
<span class="sd">            Options to pass to matplotlib plotting method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        axes_handle : matplotlib.axes.Axes</span>
<span class="sd">            Axes. See `pandas` documentation for more info</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Grab the data</span>
        <span class="c1"># self.parse()</span>
        <span class="c1"># Make a copy of the dataframe for plotting</span>

        <span class="n">plot_dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scaling</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">plot_dataframe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">plot_dataframe</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="o">/=</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_dataframe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scaling</span>

        <span class="c1"># Autocorrelation function renormalization</span>
        <span class="k">if</span> <span class="n">acf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">plot_dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">/=</span> <span class="n">plot_dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;logx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;xlabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Time difference&#39;</span>

        <span class="c1"># if self.__class__.__name__ == &#39;StaticStructureFactor&#39;:</span>
        <span class="c1">#     errorbars = plot_dataframe.copy()</span>
        <span class="c1">#     for i, col in enumerate(self.dataframe.columns):</span>
        <span class="c1">#         if col[-8:] == &#39;Errorbar&#39;:</span>
        <span class="c1">#             errorbars.drop(col, axis=1, inplace=True)</span>
        <span class="c1">#             errorbars.rename({col: col[:-9]}, axis=1, inplace=True)</span>
        <span class="c1">#             plot_dataframe.drop(col, axis=1, inplace=True)</span>
        <span class="c1">#     kwargs[&#39;yerr&#39;] = errorbars</span>
        <span class="c1">#</span>

        <span class="n">axes_handle</span> <span class="o">=</span> <span class="n">plot_dataframe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">plot_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="n">fig</span> <span class="o">=</span> <span class="n">axes_handle</span><span class="o">.</span><span class="n">figure</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># Saving</span>
        <span class="k">if</span> <span class="n">figname</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="n">figname</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s1">&#39;Plot_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">axes_handle</span></div>

<div class="viewcode-block" id="Observable.time_stamp"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Observable.time_stamp">[docs]</a>    <span class="k">def</span> <span class="nf">time_stamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timing</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print to screen the elapsed time of the calculation.&quot;&quot;&quot;</span>

        <span class="n">t_hrs</span><span class="p">,</span> <span class="n">t_min</span><span class="p">,</span> <span class="n">t_sec</span><span class="p">,</span> <span class="n">t_msec</span><span class="p">,</span> <span class="n">t_usec</span><span class="p">,</span> <span class="n">t_nsec</span> <span class="o">=</span> <span class="n">timing</span>

        <span class="k">if</span> <span class="n">t_hrs</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t_min</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t_sec</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">print_message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> Time: </span><span class="si">{}</span><span class="s1"> sec </span><span class="si">{}</span><span class="s1"> msec </span><span class="si">{}</span><span class="s1"> usec </span><span class="si">{}</span><span class="s1"> nsec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">,</span>
                                                                               <span class="nb">int</span><span class="p">(</span><span class="n">t_sec</span><span class="p">),</span>
                                                                               <span class="nb">int</span><span class="p">(</span><span class="n">t_msec</span><span class="p">),</span>
                                                                               <span class="nb">int</span><span class="p">(</span><span class="n">t_usec</span><span class="p">),</span>
                                                                               <span class="nb">int</span><span class="p">(</span><span class="n">t_nsec</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> Time: </span><span class="si">{}</span><span class="s1"> hrs </span><span class="si">{}</span><span class="s1"> min </span><span class="si">{}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">t_hrs</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">t_min</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">t_sec</span><span class="p">))</span>

        <span class="c1"># logging.info(print_message)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">print_message</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CurrentCorrelationFunction"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.CurrentCorrelationFunction">[docs]</a><span class="k">class</span> <span class="nc">CurrentCorrelationFunction</span><span class="p">(</span><span class="n">Observable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Current Correlation Functions: :math:`L(k,\\omega)` and :math:`T(k,\\omega)`.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    k_list : list</span>
<span class="sd">        List of all possible :math:`k` vectors with their corresponding magnitudes and indexes.</span>

<span class="sd">    k_counts : numpy.ndarray</span>
<span class="sd">        Number of occurrences of each :math:`k` magnitude.</span>

<span class="sd">    ka_values : numpy.ndarray</span>
<span class="sd">        Magnitude of each allowed :math:`ka` vector.</span>

<span class="sd">    no_ka_values: int</span>
<span class="sd">        Length of ``ka_values`` array.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CurrentCorrelationFunction.setup"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.CurrentCorrelationFunction.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign attributes from simulation&#39;s parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phase : str</span>
<span class="sd">            Phase to compute. Default = &#39;production&#39;.</span>

<span class="sd">        params : sarkas.base.Parameters</span>
<span class="sd">            Simulation&#39;s parameters.</span>

<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k_observable</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_init</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;ccf&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">=</span> <span class="s1">&#39;Current Correlation Function&#39;</span>

        <span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postprocessing_dir</span><span class="p">,</span> <span class="s1">&#39;CurrentCorrelationFunction&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="c1"># These calculation are needed for the io.postprocess_info().</span>
        <span class="c1"># This is a hack and we need to find a faster way to do it</span>
        <span class="n">dt_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_min</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="n">dt_r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">dt_r</span>  <span class="c1"># Half because np.fft calculates negative and positive frequencies</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parse_k_data</span><span class="p">()</span>

        <span class="c1"># self.filename_csv_longitudinal = os.path.join(self.saving_dir,</span>
        <span class="c1">#                                               &quot;Longitudinal_CurrentCorrelationFunction_&quot; + self.job_id + &#39;.csv&#39;)</span>
        <span class="c1"># self.filename_csv_transverse = os.path.join(self.saving_dir,</span>
        <span class="c1">#                                             &quot;Transverse_CurrentCorrelationFunction_&quot; + self.job_id + &#39;.csv&#39;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span>
            <span class="s2">&quot;CurrentCorrelationFunction_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span><span class="p">)</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></div>

<div class="viewcode-block" id="CurrentCorrelationFunction.compute"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.CurrentCorrelationFunction.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the microscopic current fluctuations correlation functions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="c1"># Parse vkt otherwise calculate them</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_k_data</span><span class="p">()</span>  <span class="c1"># repeat from setup in case parameters have been updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_kt_data</span><span class="p">(</span><span class="n">nkt_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vkt_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Initialize dataframes and add frequencies to it.</span>
        <span class="c1"># This re-initialization of the dataframe is needed to avoid len mismatch conflicts when re-calculating</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span>

        <span class="c1"># self.dataframe_longitudinal[&quot;Frequencies&quot;] = np.fft.fftshift(self.frequencies)</span>
        <span class="c1"># self.dataframe_transverse[&quot;Frequencies&quot;] = np.fft.fftshift(self.frequencies)</span>

        <span class="c1"># temp_dataframe_longitudinal = pd.DataFrame()</span>
        <span class="n">temp_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">tinit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>

        <span class="n">vkt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vkt_hdf_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;vkt&#39;</span><span class="p">)</span>
        <span class="c1"># Containers</span>
        <span class="n">vkt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="n">vkt_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="n">vkt_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="n">vkt_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">):</span>

            <span class="c1"># Put data in the container to pass</span>
            <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
                <span class="n">vkt</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vkt_df</span><span class="p">[</span><span class="s2">&quot;slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;Longitudinal&quot;</span><span class="p">][</span><span class="n">sp_name</span><span class="p">])</span>
                <span class="n">vkt_i</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vkt_df</span><span class="p">[</span><span class="s2">&quot;slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;Transverse i&quot;</span><span class="p">][</span><span class="n">sp_name</span><span class="p">])</span>
                <span class="n">vkt_j</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vkt_df</span><span class="p">[</span><span class="s2">&quot;slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;Transverse j&quot;</span><span class="p">][</span><span class="n">sp_name</span><span class="p">])</span>
                <span class="n">vkt_k</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vkt_df</span><span class="p">[</span><span class="s2">&quot;slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="s2">&quot;Transverse k&quot;</span><span class="p">][</span><span class="n">sp_name</span><span class="p">])</span>

            <span class="c1"># Calculate Lkw and Tkw</span>
            <span class="n">Lkw</span> <span class="o">=</span> <span class="n">calc_Skw</span><span class="p">(</span><span class="n">vkt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>
            <span class="n">Tkw_i</span> <span class="o">=</span> <span class="n">calc_Skw</span><span class="p">(</span><span class="n">vkt_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>
            <span class="n">Tkw_j</span> <span class="o">=</span> <span class="n">calc_Skw</span><span class="p">(</span><span class="n">vkt_j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>
            <span class="n">Tkw_k</span> <span class="o">=</span> <span class="n">calc_Skw</span><span class="p">(</span><span class="n">vkt_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>

            <span class="n">Tkw</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tkw_i</span> <span class="o">+</span> <span class="n">Tkw_j</span> <span class="o">+</span> <span class="n">Tkw_k</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span>

            <span class="c1"># Lkw_tot += Lkw / self.no_slices</span>
            <span class="c1"># Tkw_tot += Tkw / self.no_slices</span>
            <span class="c1"># Create the dataframe&#39;s column names</span>
            <span class="n">slc_column</span> <span class="o">=</span> <span class="s1">&#39;slice </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ka_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ka = </span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ka</span><span class="p">)</span> <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">)]</span>

            <span class="c1"># Save the full Skw into a Dataframe</span>
            <span class="n">sp_indx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">sp2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">[</span><span class="n">i</span><span class="p">:]):</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;Longitudinal_</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)</span> <span class="o">+</span> <span class="n">slc_column</span> <span class="o">+</span>
                        <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">_k = [</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">ka_columns</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                        <span class="c1"># Final string : Longitudinal_H-He_slice 1_ka = 0.123456_k = [0, 0, 1]</span>
                        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">))]</span>
                    <span class="n">temp_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">temp_dataframe</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Lkw</span><span class="p">[</span><span class="n">sp_indx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)],</span>
                        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;Transverse_</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)</span> <span class="o">+</span> <span class="n">slc_column</span> <span class="o">+</span>
                        <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">_k = [</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">ka_columns</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                        <span class="c1"># Final string : Transverse_H-He_slice 1_ka = 0.123456_k = [0, 0, 1]</span>
                        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">))]</span>
                    <span class="n">temp_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">temp_dataframe</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Tkw</span><span class="p">[</span><span class="n">sp_indx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)],</span>
                        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">sp_indx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Create the MultiIndex</span>
        <span class="n">tuples</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">temp_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">temp_dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">tuples</span><span class="p">,</span>
                                                           <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="s1">&#39;slices&#39;</span><span class="p">,</span> <span class="s1">&#39;ka_value&#39;</span><span class="p">,</span>
                                                                  <span class="s1">&#39;k_harmonics&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_Full.h5&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_Full.h5&#39;</span><span class="p">)</span>

        <span class="n">temp_dataframe</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_Full.h5&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="c1"># This re-initialization of the dataframe is needed to avoid len mismatch conflicts when re-calculating</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39; _ _ _ _Frequencies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span>
        <span class="c1"># Take the mean and std and store them into the dataframe to return</span>
        <span class="k">for</span> <span class="n">sp1</span><span class="p">,</span> <span class="n">sp1_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sp2</span><span class="p">,</span> <span class="n">sp2_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">[</span><span class="n">sp1</span><span class="p">:],</span> <span class="n">sp1</span><span class="p">):</span>
                <span class="n">comp_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1_name</span><span class="p">,</span> <span class="n">sp2_name</span><span class="p">)</span>
                <span class="c1">### LONGITUDINAL</span>
                <span class="c1"># Rename the columns with values of ka</span>
                <span class="n">ka_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Longitudinal_&#39;</span> <span class="o">+</span> <span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_Mean_ka = </span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ka</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">)]</span>

                <span class="c1"># Mean: level = 1 corresponds to averaging all the k harmonics with the same magnitude</span>
                <span class="n">df_mean</span> <span class="o">=</span> <span class="n">temp_dataframe</span><span class="p">[</span><span class="s1">&#39;Longitudinal&#39;</span><span class="p">][</span><span class="n">comp_name</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
                <span class="n">df_mean</span> <span class="o">=</span> <span class="n">df_mean</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">col_mapper</span><span class="p">(</span><span class="n">df_mean</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">ka_columns</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Std</span>
                <span class="n">ka_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Longitudinal_&#39;</span> <span class="o">+</span> <span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_Std_ka = </span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ka</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">)]</span>
                <span class="n">df_std</span> <span class="o">=</span> <span class="n">temp_dataframe</span><span class="p">[</span><span class="s1">&#39;Longitudinal&#39;</span><span class="p">][</span><span class="n">comp_name</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
                <span class="n">df_std</span> <span class="o">=</span> <span class="n">df_std</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">col_mapper</span><span class="p">(</span><span class="n">df_std</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">ka_columns</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">df_mean</span><span class="p">,</span> <span class="n">df_std</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1">### Transverse</span>
                <span class="c1"># Rename the columns with values of ka</span>
                <span class="n">ka_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Transverse_&#39;</span> <span class="o">+</span> <span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_Mean_ka = </span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ka</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">)]</span>

                <span class="c1"># Mean: level = 1 corresponds to averaging all the k harmonics with the same magnitude</span>
                <span class="n">tdf_mean</span> <span class="o">=</span> <span class="n">temp_dataframe</span><span class="p">[</span><span class="s1">&#39;Transverse&#39;</span><span class="p">][</span><span class="n">comp_name</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
                <span class="n">tdf_mean</span> <span class="o">=</span> <span class="n">tdf_mean</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">col_mapper</span><span class="p">(</span><span class="n">tdf_mean</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">ka_columns</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Std</span>
                <span class="n">ka_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Transverse_&#39;</span> <span class="o">+</span> <span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_Std_ka = </span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ka</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">)]</span>
                <span class="n">tdf_std</span> <span class="o">=</span> <span class="n">temp_dataframe</span><span class="p">[</span><span class="s1">&#39;Transverse&#39;</span><span class="p">][</span><span class="n">comp_name</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
                <span class="n">tdf_std</span> <span class="o">=</span> <span class="n">tdf_std</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">col_mapper</span><span class="p">(</span><span class="n">tdf_std</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">ka_columns</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">tdf_mean</span><span class="p">,</span> <span class="n">tdf_std</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create the MultiIndex columns:</span>
        <span class="c1"># Longitudinal_H-He_Mean_Frequencies | ka = 0.123456</span>
        <span class="c1"># Longitudinal_H-He_Std_ka = 0.123456</span>

        <span class="n">tuples</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">tuples</span><span class="p">)</span>

        <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">+</span> <span class="s2">&quot; Calculation&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">time_division</span><span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tinit</span><span class="p">))</span>

        <span class="c1"># HDF will get huge if we don&#39;t remove</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span></div>

<div class="viewcode-block" id="CurrentCorrelationFunction.pretty_print"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.CurrentCorrelationFunction.pretty_print">[docs]</a>    <span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print current correlation function calculation parameters for help in choice of simulation parameters.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="si">{:=^70}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;k wavevector information saved in: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;v(k,t) data saved in: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vkt_hdf_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data saved in: </span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data accessible at: self.k_list, self.k_counts, self.ka_values, self.frequencies,&#39;</span>
              <span class="s1">&#39; </span><span class="se">\n\t</span><span class="s1"> self.dataframe&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Frequency Space Parameters:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">No. of slices = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">No. dumps per slice = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Frequency step dw = 2 pi (no_slices * prod_dump_step)/(production_steps * dt)&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">dw = </span><span class="si">{:1.4f}</span><span class="s1"> w_p = </span><span class="si">{:1.4e}</span><span class="s1"> [Hz]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_min</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plasma_frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_min</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum Frequency w_max = 2 pi /(prod_dump_step * dt)&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">w_max = </span><span class="si">{:1.4f}</span><span class="s1"> w_p = </span><span class="si">{:1.4e}</span><span class="s1"> [Hz]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_max</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plasma_frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_max</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Wavevector parameters:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Smallest wavevector k_min = 2 pi / L = 3.9 / N^(1/3)&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;k_min = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Angle averaging choice: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum angle averaged k harmonics = n_x, n_y, n_z = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Largest angle averaged k_max = k_min * sqrt( n_x^2 + n_y^2 + n_z^2)&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">k_max = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum angle averaged k harmonics = n_x, n_y, n_z = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Largest angle averaged k_max = k_min * sqrt( n_x^2 + n_y^2 + n_z^2)&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">AA k_max = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum k harmonics = n_x, n_y, n_z = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Largest wavector k_max = k_min * n_x&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">k_max = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;principal_axis&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum k harmonics = n_x, n_y, n_z = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Largest wavector k_max = k_min * n_x&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">k_max = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Total number of k values to calculate = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of unique ka values to calculate = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">)))</span></div></div>


<div class="viewcode-block" id="DynamicStructureFactor"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.DynamicStructureFactor">[docs]</a><span class="k">class</span> <span class="nc">DynamicStructureFactor</span><span class="p">(</span><span class="n">Observable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dynamic Structure factor.    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DynamicStructureFactor.setup"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.DynamicStructureFactor.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign attributes from simulation&#39;s parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phase : str</span>
<span class="sd">            Phase to compute. Default = &#39;production&#39;.</span>

<span class="sd">        params : sarkas.base.Parameters</span>
<span class="sd">            Simulation&#39;s parameters.</span>

<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k_observable</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_init</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;dsf&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">=</span> <span class="s1">&#39;Dynamic Structure Factor&#39;</span>

        <span class="c1"># Create the directory where to store the computed data</span>
        <span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postprocessing_dir</span><span class="p">,</span> <span class="s1">&#39;DynamicStructureFactor&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="c1"># Create the phase directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="c1"># These calculation are needed for the io.postprocess_info().</span>
        <span class="c1"># This is a hack and we need to find a faster way to do it</span>
        <span class="n">dt_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_min</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">dt_r</span>  <span class="c1"># Half because np.fft calculates negative and positive frequencies</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parse_k_data</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s2">&quot;DynamicStructureFactor_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s2">&quot;DynamicStructureFactor_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span><span class="p">)</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></div>

<div class="viewcode-block" id="DynamicStructureFactor.compute"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.DynamicStructureFactor.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute :math:`S_{ij} (k,\\omega)` and the array of :math:`\\omega` values.</span>
<span class="sd">        Shape = (``no_ws``, ``no_Sij``)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Parse nkt otherwise calculate it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_k_data</span><span class="p">()</span>  <span class="c1"># repeat from setup in case parameters have been updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_kt_data</span><span class="p">(</span><span class="n">nkt_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span>

        <span class="c1"># Save the raw Skw data into a temporary dataframe.</span>
        <span class="c1"># The final Skw will be calculated using mean and std on this dataframe</span>
        <span class="n">temp_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">tinit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="n">nkt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkt_hdf_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;nkt&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">):</span>
            <span class="c1"># Initialize container</span>
            <span class="n">nkt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
                <span class="n">nkt</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nkt_df</span><span class="p">[</span><span class="s2">&quot;slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="n">sp_name</span><span class="p">])</span>

            <span class="c1"># Calculate Skw</span>
            <span class="n">Skw_all</span> <span class="o">=</span> <span class="n">calc_Skw</span><span class="p">(</span><span class="n">nkt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>

            <span class="c1"># Create the dataframe&#39;s column names</span>
            <span class="n">slc_column</span> <span class="o">=</span> <span class="s1">&#39;slice </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ka_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ka = </span><span class="si">{:.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ka</span><span class="p">)</span> <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">)]</span>
            <span class="c1"># Save the full Skw into a Dataframe</span>
            <span class="n">sp_indx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">sp2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">[</span><span class="n">i</span><span class="p">:]):</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)</span> <span class="o">+</span> <span class="n">slc_column</span> <span class="o">+</span>
                        <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">_k = [</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">ka_columns</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_harmonics</span><span class="p">))]</span>
                    <span class="n">temp_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">temp_dataframe</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Skw_all</span><span class="p">[</span><span class="n">sp_indx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)],</span>
                        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">sp_indx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Create the MultiIndex</span>
        <span class="n">tuples</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">temp_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">temp_dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">tuples</span><span class="p">,</span>
                                                           <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="s1">&#39;slices&#39;</span><span class="p">,</span> <span class="s1">&#39;k_index&#39;</span><span class="p">,</span> <span class="s1">&#39;k_harmonics&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_Full.h5&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_Full.h5&#39;</span><span class="p">)</span>
        <span class="n">temp_dataframe</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_Full.h5&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="c1"># This re-initialization of the dataframe is needed to avoid len mismatch conflicts when re-calculating</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot; _ _Frequencies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span>

        <span class="c1"># Take the mean and std and store them into the dataframe to return</span>
        <span class="k">for</span> <span class="n">sp1</span><span class="p">,</span> <span class="n">sp1_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sp2</span><span class="p">,</span> <span class="n">sp2_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">[</span><span class="n">sp1</span><span class="p">:],</span> <span class="n">sp1</span><span class="p">):</span>
                <span class="n">skw_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1_name</span><span class="p">,</span> <span class="n">sp2_name</span><span class="p">)</span>
                <span class="c1"># Rename the columns with values of ka</span>
                <span class="n">ka_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">skw_name</span> <span class="o">+</span> <span class="s2">&quot;_Mean_ka = </span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ka</span><span class="p">)</span> <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">)]</span>
                <span class="c1"># Mean: level = 1 corresponds to averaging all the k harmonics with the same magnitude</span>
                <span class="n">df_mean</span> <span class="o">=</span> <span class="n">temp_dataframe</span><span class="p">[</span><span class="n">skw_name</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
                <span class="n">df_mean</span> <span class="o">=</span> <span class="n">df_mean</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">col_mapper</span><span class="p">(</span><span class="n">df_mean</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">ka_columns</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Std</span>
                <span class="n">ka_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">skw_name</span> <span class="o">+</span> <span class="s2">&quot;_Std_ka = </span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ka</span><span class="p">)</span> <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">)]</span>
                <span class="n">df_std</span> <span class="o">=</span> <span class="n">temp_dataframe</span><span class="p">[</span><span class="n">skw_name</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
                <span class="n">df_std</span> <span class="o">=</span> <span class="n">df_std</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">col_mapper</span><span class="p">(</span><span class="n">df_std</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">ka_columns</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">df_mean</span><span class="p">,</span> <span class="n">df_std</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create the MultiIndex columns</span>
        <span class="n">tuples</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">tuples</span><span class="p">)</span>

        <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">+</span> <span class="s2">&quot; Calculation&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">time_division</span><span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tinit</span><span class="p">))</span>

        <span class="c1"># HDF will get huge if we don&#39;t remove</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span></div>

<div class="viewcode-block" id="DynamicStructureFactor.pretty_print"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.DynamicStructureFactor.pretty_print">[docs]</a>    <span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print dynamic structure factor calculation parameters for help in choice of simulation parameters.&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="si">{:=^70}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;k wavevector information saved in: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;n(k,t) data saved in: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkt_hdf_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data saved in: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data accessible at: self.k_list, self.k_counts, self.ka_values, self.frequencies, self.dataframe&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Frequency Space Parameters:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">No. of slices = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">No. dumps per slice = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Frequency step dw = 2 pi (no_slices * prod_dump_step)/(production_steps * dt)&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">dw = </span><span class="si">{:1.4f}</span><span class="s1"> w_p = </span><span class="si">{:1.4e}</span><span class="s1"> [Hz]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_min</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plasma_frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_min</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum Frequency w_max = 2 pi /(prod_dump_step * dt)&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">w_max = </span><span class="si">{:1.4f}</span><span class="s1"> w_p = </span><span class="si">{:1.4e}</span><span class="s1"> [Hz]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_max</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plasma_frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_max</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Wavevector parameters:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Smallest wavevector k_min = 2 pi / L = 3.9 / N^(1/3)&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;k_min = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Angle averaging choice: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum angle averaged k harmonics = n_x, n_y, n_z = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Largest angle averaged k_max = k_min * sqrt( n_x^2 + n_y^2 + n_z^2)&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">k_max = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum angle averaged k harmonics = n_x, n_y, n_z = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Largest angle averaged k_max = k_min * sqrt( n_x^2 + n_y^2 + n_z^2)&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">AA k_max = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum k harmonics = n_x, n_y, n_z = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Largest wavector k_max = k_min * n_x&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">k_max = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;principal_axis&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum k harmonics = n_x, n_y, n_z = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Largest wavector k_max = k_min * n_x&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">k_max = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Total number of k values to calculate = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of unique ka values to calculate = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">)))</span></div></div>


<div class="viewcode-block" id="ElectricCurrent"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.ElectricCurrent">[docs]</a><span class="k">class</span> <span class="nc">ElectricCurrent</span><span class="p">(</span><span class="n">Observable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Electric Current Auto-correlation function.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ElectricCurrent.setup"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.ElectricCurrent.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the attributes from simulation&#39;s parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phase : str</span>
<span class="sd">            Phase to compute. Default = &#39;production&#39;.</span>

<span class="sd">        params : sarkas.base.Parameters</span>
<span class="sd">            Simulation&#39;s parameters.</span>

<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;ec&#39;</span>

        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_init</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>

        <span class="c1"># Create the directory where to store the computed data</span>
        <span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postprocessing_dir</span><span class="p">,</span> <span class="s1">&#39;ElectricCurrent&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s2">&quot;ElectricCurrent_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></div>

<div class="viewcode-block" id="ElectricCurrent.compute"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.ElectricCurrent.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the electric current and the corresponding auto-correlation functions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Parse the particles from the dump files</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_num_ptcls</span><span class="p">))</span>
        <span class="c1">#</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parsing particles&#39; velocities.&quot;</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)):</span>
            <span class="n">dump</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">it</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>
            <span class="n">time</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">dump</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="n">datap</span> <span class="o">=</span> <span class="n">load_from_restart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span><span class="p">,</span> <span class="n">dump</span><span class="p">)</span>
            <span class="n">vel</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">vel</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">vel</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating Electric current quantities.&quot;</span><span class="p">)</span>
        <span class="n">species_current</span><span class="p">,</span> <span class="n">total_current</span> <span class="o">=</span> <span class="n">calc_elec_current</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_charges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Total Current X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_current</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Total Current Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_current</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Total Current Z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_current</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Calculate the ACF in each direction</span>
        <span class="n">cur_acf_xx</span> <span class="o">=</span> <span class="n">correlationfunction</span><span class="p">(</span><span class="n">total_current</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">total_current</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">cur_acf_yy</span> <span class="o">=</span> <span class="n">correlationfunction</span><span class="p">(</span><span class="n">total_current</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">total_current</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">cur_acf_zz</span> <span class="o">=</span> <span class="n">correlationfunction</span><span class="p">(</span><span class="n">total_current</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">total_current</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
        <span class="c1"># Total Current ACF</span>
        <span class="n">tot_cur_acf</span> <span class="o">=</span> <span class="n">cur_acf_xx</span> <span class="o">+</span> <span class="n">cur_acf_yy</span> <span class="o">+</span> <span class="n">cur_acf_zz</span>

        <span class="c1"># Save</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;X Current ACF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_acf_xx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Y Current ACF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_acf_yy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Z Current ACF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_acf_zz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Total Current ACF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot_cur_acf</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
            <span class="n">acf_xx</span> <span class="o">=</span> <span class="n">correlationfunction</span><span class="p">(</span><span class="n">species_current</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">species_current</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">acf_yy</span> <span class="o">=</span> <span class="n">correlationfunction</span><span class="p">(</span><span class="n">species_current</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">species_current</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">acf_zz</span> <span class="o">=</span> <span class="n">correlationfunction</span><span class="p">(</span><span class="n">species_current</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">species_current</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">tot_acf</span> <span class="o">=</span> <span class="n">acf_xx</span> <span class="o">+</span> <span class="n">acf_yy</span> <span class="o">+</span> <span class="n">acf_zz</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Total Current&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">species_current</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">species_current</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">species_current</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> X Current&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">species_current</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Y Current&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">species_current</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Z Current&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">species_current</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Total Current ACF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tot_acf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> X Current ACF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">acf_xx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Y Current ACF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">acf_yy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Z Current ACF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">acf_zz</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RadialDistributionFunction"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.RadialDistributionFunction">[docs]</a><span class="k">class</span> <span class="nc">RadialDistributionFunction</span><span class="p">(</span><span class="n">Observable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Radial Distribution Function.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    no_bins : int</span>
<span class="sd">        Number of bins.</span>

<span class="sd">    dr_rdf : float</span>
<span class="sd">        Size of each bin.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RadialDistributionFunction.setup"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.RadialDistributionFunction.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign attributes from simulation&#39;s parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phase : str</span>
<span class="sd">            Phase to compute. Default = &#39;production&#39;.</span>

<span class="sd">        params : sarkas.base.Parameters</span>
<span class="sd">            Simulation&#39;s parameters.</span>

<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_init</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;rdf&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">=</span> <span class="s1">&#39;Radial Distribution Function&#39;</span>

        <span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postprocessing_dir</span><span class="p">,</span> <span class="s1">&#39;RadialDistributionFunction&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span>
                                         <span class="s2">&quot;RadialDistributionFunction_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">)</span>

        <span class="c1"># These definitions are needed for the print out.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdf_nbins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dr_rdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_bins</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></div>

<div class="viewcode-block" id="RadialDistributionFunction.compute"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.RadialDistributionFunction.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdf_hist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rdf_hist : numpy.ndarray</span>
<span class="sd">            Histogram of the radial distribution function.</span>

<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># initialize temporary arrays</span>
        <span class="n">r_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_bins</span><span class="p">)</span>
        <span class="n">bin_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_bins</span><span class="p">)</span>
        <span class="n">pair_density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">))</span>
        <span class="n">gr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">no_bins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_obs</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rdf_hist</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="c1"># Find the last dump by looking for the largest number in the checkpoints filenames</span>
            <span class="n">dumps_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span><span class="p">)</span>
            <span class="n">dumps_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">num_sort</span><span class="p">)</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">dumps_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">number</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">load_from_restart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">))</span>
            <span class="n">rdf_hist</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rdf_hist&quot;</span><span class="p">]</span>

        <span class="c1"># Make sure you are getting the right number of bins and redefine dr_rdf.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_bins</span> <span class="o">=</span> <span class="n">rdf_hist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dr_rdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_bins</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="c1"># No. of pairs per volume</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">):</span>
            <span class="n">pair_density</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp1</span> <span class="o">*</span> <span class="p">(</span><span class="n">sp1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_volume</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_species</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">sp2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">pair_density</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp1</span> <span class="o">*</span> <span class="n">sp2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_volume</span>

        <span class="c1"># Calculate the volume of each bin</span>
        <span class="n">sphere_shell_const</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">3.0</span>
        <span class="n">bin_vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sphere_shell_const</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr_rdf</span> <span class="o">**</span> <span class="mi">3</span>
        <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_bins</span><span class="p">):</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="n">ir</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr_rdf</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr_rdf</span>
            <span class="n">bin_vol</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">sphere_shell_const</span> <span class="o">*</span> <span class="p">(</span><span class="n">r2</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">r1</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">r_values</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr_rdf</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ra_values</span> <span class="o">=</span> <span class="n">r_values</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_values</span>
        <span class="n">gr_ij</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">sp2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">i</span><span class="p">):</span>
                <span class="n">denom_const</span> <span class="o">=</span> <span class="p">(</span><span class="n">pair_density</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">production_steps</span><span class="p">)</span>
                <span class="n">gr</span><span class="p">[:,</span> <span class="n">gr_ij</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdf_hist</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">rdf_hist</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom_const</span> <span class="o">/</span> <span class="n">bin_vol</span><span class="p">[:]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1"> RDF&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">gr</span><span class="p">[:,</span> <span class="n">gr_ij</span><span class="p">]</span>

                <span class="n">gr_ij</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">(</span><span class="s1">&#39;Radial Distribution Function Calculation&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">time_division</span><span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RadialDistributionFunction.pretty_print"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.RadialDistributionFunction.pretty_print">[docs]</a>    <span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print radial distribution function calculation parameters for help in choice of simulation parameters.&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="si">{:=^70}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data saved in: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data accessible at: self.ra_values, self.dataframe&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No. bins = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_bins</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dr = </span><span class="si">{:1.4f}</span><span class="s1"> a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dr_rdf</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr_rdf</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[m]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum Distance (i.e. potential.rc)= </span><span class="si">{:1.4f}</span><span class="s1"> a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[m]&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="StaticStructureFactor"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.StaticStructureFactor">[docs]</a><span class="k">class</span> <span class="nc">StaticStructureFactor</span><span class="p">(</span><span class="n">Observable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Static Structure Factors :math:`S_{ij}(k)`.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    k_list : list</span>
<span class="sd">        List of all possible :math:`k` vectors with their corresponding magnitudes and indexes.</span>

<span class="sd">    k_counts : numpy.ndarray</span>
<span class="sd">        Number of occurrences of each :math:`k` magnitude.</span>

<span class="sd">    ka_values : numpy.ndarray</span>
<span class="sd">        Magnitude of each allowed :math:`ka` vector.</span>

<span class="sd">    no_ka_values: int</span>
<span class="sd">        Length of ``ka_values`` array.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="StaticStructureFactor.setup"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.StaticStructureFactor.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign attributes from simulation&#39;s parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phase : str</span>
<span class="sd">            Phase to compute. Default = &#39;production&#39;.</span>

<span class="sd">        params : sarkas.base.Parameters</span>
<span class="sd">            Simulation&#39;s parameters.</span>

<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k_observable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_init</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;ssf&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">=</span> <span class="s1">&#39;Static Structure Function&#39;</span>

        <span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postprocessing_dir</span><span class="p">,</span> <span class="s1">&#39;StaticStructureFunction&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="c1"># These calculation are needed for the io.postprocess_info().</span>
        <span class="c1"># This is a hack and we need to find a faster way to do it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">production_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_dump_step</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parse_k_data</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s2">&quot;StaticStructureFunction_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s2">&quot;.h5&quot;</span><span class="p">)</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></div>

<div class="viewcode-block" id="StaticStructureFactor.compute"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.StaticStructureFactor.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate all :math:`S_{ij}(k)`, save them into a Pandas dataframe, and write them to a csv.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Parse nkt otherwise calculate it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_k_data</span><span class="p">()</span>  <span class="c1"># repeat from setup in case parameters have been updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_kt_data</span><span class="p">(</span><span class="n">nkt_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># This re-initialization of the dataframe is needed to avoid len mismatch conflicts when re-calculating</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">no_dumps_calculated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span>
        <span class="n">Sk_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">no_obs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_counts</span><span class="p">),</span> <span class="n">no_dumps_calculated</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating S(k) ...&quot;</span><span class="p">)</span>

        <span class="n">tinit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="n">nkt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nkt_hdf_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;nkt&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">)):</span>
            <span class="c1"># Initialize container</span>
            <span class="n">nkt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
                <span class="n">nkt</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nkt_df</span><span class="p">[</span><span class="s2">&quot;slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="n">sp_name</span><span class="p">])</span>

            <span class="n">init</span> <span class="o">=</span> <span class="n">isl</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span>
            <span class="n">fin</span> <span class="o">=</span> <span class="p">(</span><span class="n">isl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span>
            <span class="n">Sk_avg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">init</span><span class="p">:</span><span class="n">fin</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_Sk</span><span class="p">(</span><span class="n">nkt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_counts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">)</span>

        <span class="n">Sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Sk_avg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Sk_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">Sk_avg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">k_column</span> <span class="o">=</span> <span class="s2">&quot; _k values&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">k_column</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_values</span>
        <span class="n">sp_indx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">sp2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">[</span><span class="n">i</span><span class="p">:]):</span>
                <span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">_Mean&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)</span>
                <span class="n">err_column</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">_Std&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sk</span><span class="p">[</span><span class="n">sp_indx</span><span class="p">,</span> <span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">err_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sk_err</span><span class="p">[</span><span class="n">sp_indx</span><span class="p">,</span> <span class="p">:]</span>

                <span class="n">sp_indx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Create the MultiIndex columns</span>
        <span class="n">tuples</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">tuples</span><span class="p">)</span>

        <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">+</span> <span class="s2">&quot; Calculation&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">time_division</span><span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tinit</span><span class="p">))</span>

        <span class="c1"># HDF will get huge if we don&#39;t remove</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span></div>

<div class="viewcode-block" id="StaticStructureFactor.pretty_print"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.StaticStructureFactor.pretty_print">[docs]</a>    <span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print static structure factor calculation parameters for help in choice of simulation parameters.&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="si">{:=^70}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;k wavevector information saved in: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;n(k,t) Data saved in: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nkt_hdf_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data saved in: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data accessible at: self.k_list, self.k_counts, self.ka_values, self.dataframe&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Smallest wavevector k_min = 2 pi / L = 3.9 / N^(1/3)&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;k_min = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Angle averaging choice: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum angle averaged k harmonics = n_x, n_y, n_z = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Largest angle averaged k_max = k_min * sqrt( n_x^2 + n_y^2 + n_z^2)&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">k_max = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum angle averaged k harmonics = n_x, n_y, n_z = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_harmonics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Largest angle averaged k_max = k_min * sqrt( n_x^2 + n_y^2 + n_z^2)&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">AA k_max = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">max_aa_ka_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum k harmonics = n_x, n_y, n_z = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Largest wavector k_max = k_min * n_x&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">k_max = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;principal_axis&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Maximum k harmonics = n_x, n_y, n_z = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_k_harmonics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Largest wavector k_max = k_min * n_x&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">k_max = </span><span class="si">{:.4f}</span><span class="s1"> / a_ws = </span><span class="si">{:1.4e}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">max_ka_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ws</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[1/cm]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[1/m]&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Total number of k values to calculate = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_list</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of unique ka values to calculate = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ka_values</span><span class="p">)))</span></div></div>


<div class="viewcode-block" id="Thermodynamics"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Thermodynamics">[docs]</a><span class="k">class</span> <span class="nc">Thermodynamics</span><span class="p">(</span><span class="n">Observable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Thermodynamic functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Thermodynamics.setup"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Thermodynamics.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign attributes from simulation&#39;s parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phase : str</span>
<span class="sd">            Phase to compute. Default = &#39;production&#39;.</span>

<span class="sd">        params : sarkas.base.Parameters</span>
<span class="sd">            Simulation&#39;s parameters.</span>

<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_init</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;therm&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">=</span> <span class="s1">&#39;Thermodynamics&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">load_method</span> <span class="o">==</span> <span class="s2">&quot;restart&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_sim</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_sim</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">production_dir</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;equilibration&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_dir</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;magnetization&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnetization_dir</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></div>

<div class="viewcode-block" id="Thermodynamics.compute_pressure_quantities"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Thermodynamics.compute_pressure_quantities">[docs]</a>    <span class="k">def</span> <span class="nf">compute_pressure_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate Pressure, Pressure Tensor, Pressure Tensor Auto Correlation Function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;production&#39;</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_num_ptcls</span><span class="p">))</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_num_ptcls</span><span class="p">))</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_num_ptcls</span><span class="p">))</span>

        <span class="n">pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span><span class="p">)</span>
        <span class="n">pressure_tensor_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span><span class="p">))</span>

        <span class="c1"># Collect particles&#39; positions, velocities and accelerations</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span><span class="p">)):</span>
            <span class="n">dump</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">it</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">load_from_restart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span><span class="p">,</span> <span class="n">dump</span><span class="p">)</span>
            <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span>

            <span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">vel</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span>

            <span class="n">acc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">acc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">acc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span>

            <span class="n">pressure</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="n">pressure_tensor_temp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_pressure_tensor</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_masses</span><span class="p">,</span>
                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_volume</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Pressure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pressure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Pressure ACF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlationfunction</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="n">pressure</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">dim_lbl</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">dim_lbl</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>

        <span class="c1"># Calculate the acf of the pressure tensor</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dim_lbl</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ax2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dim_lbl</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Pressure Tensor </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pressure_tensor_temp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">pressure_tensor_acf_temp</span> <span class="o">=</span> <span class="n">correlationfunction</span><span class="p">(</span><span class="n">pressure_tensor_temp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:],</span>
                                                               <span class="n">pressure_tensor_temp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Pressure Tensor ACF </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pressure_tensor_acf_temp</span>

        <span class="c1"># Save the pressure acf to file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prod_energy_filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Thermodynamics.compute_pressure_from_rdf"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Thermodynamics.compute_pressure_from_rdf">[docs]</a>    <span class="k">def</span> <span class="nf">compute_pressure_from_rdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">gr</span><span class="p">,</span> <span class="n">potential</span><span class="p">,</span> <span class="n">potential_matrix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the Pressure using the radial distribution function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        potential: str</span>
<span class="sd">            Potential used in the simulation.</span>

<span class="sd">        potential_matrix: numpy.ndarray</span>
<span class="sd">            Potential parameters.</span>

<span class="sd">        r : numpy.ndarray</span>
<span class="sd">            Particles&#39; distances.</span>

<span class="sd">        gr : numpy.ndarray</span>
<span class="sd">            Pair distribution function.</span>

<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pressure : float</span>
<span class="sd">            Pressure divided by :math:`k_BT`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="n">r2</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span>
        <span class="n">r3</span> <span class="o">=</span> <span class="n">r2</span> <span class="o">*</span> <span class="n">r</span>

        <span class="k">if</span> <span class="n">potential</span> <span class="o">==</span> <span class="s2">&quot;Coulomb&quot;</span><span class="p">:</span>
            <span class="n">dv_dr</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">r2</span>
            <span class="c1"># Check for finiteness of first element when r[0] = 0.0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dv_dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">dv_dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dv_dr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">gr</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">potential</span> <span class="o">==</span> <span class="s2">&quot;Yukawa&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">potential</span> <span class="o">==</span> <span class="s2">&quot;QSP&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown potential&#39;</span><span class="p">)</span>

        <span class="c1"># No. of independent g(r)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Temperature&quot;</span><span class="p">])</span>
        <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kB</span> <span class="o">*</span> <span class="n">T</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_num_dens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
                   <span class="o">*</span> <span class="n">potential_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">dv_dr</span> <span class="o">*</span> <span class="n">r3</span> <span class="o">*</span> <span class="n">gr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
        <span class="n">pressure</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_num_dens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">pressure</span></div>

<div class="viewcode-block" id="Thermodynamics.parse"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Thermodynamics.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Grab the pandas dataframe from the saved csv file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;equilibration&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eq_energy_filename</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fldr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_dir</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prod_energy_filename</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fldr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">production_dir</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;magnetization&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_energy_filename</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fldr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnetization_dir</span></div>

<div class="viewcode-block" id="Thermodynamics.statistics"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Thermodynamics.statistics">[docs]</a>    <span class="k">def</span> <span class="nf">statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="s2">&quot;Total Energy&quot;</span><span class="p">,</span> <span class="n">max_no_divisions</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ToDo:</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        quantity</span>
<span class="sd">        max_no_divisions</span>
<span class="sd">        show</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="n">run_avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">quantity</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">run_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">quantity</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="n">observable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">quantity</span><span class="p">])</span>
        <span class="c1"># Loop over the blocks</span>
        <span class="n">tau_blk</span><span class="p">,</span> <span class="n">sigma2_blk</span><span class="p">,</span> <span class="n">statistical_efficiency</span> <span class="o">=</span> <span class="n">calc_statistical_efficiency</span><span class="p">(</span><span class="n">observable</span><span class="p">,</span>
                                                                                  <span class="n">run_avg</span><span class="p">,</span> <span class="n">run_std</span><span class="p">,</span>
                                                                                  <span class="n">max_no_divisions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span><span class="p">)</span>
        <span class="c1"># Plot the statistical efficiency</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tau_blk</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">statistical_efficiency</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="s1">&#39;--o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">quantity</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$s(\tau_{\rm</span><span class="si">{blk}</span><span class="s1">})$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$1/\tau_{\rm</span><span class="si">{blk}</span><span class="s1">}$&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postproc_dir</span><span class="p">,</span> <span class="n">quantity</span> <span class="o">+</span> <span class="s1">&#39;StatisticalEfficiency_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Thermodynamics.temp_energy_plot"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.Thermodynamics.temp_energy_plot">[docs]</a>    <span class="k">def</span> <span class="nf">temp_energy_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span>
                         <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">publication</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">figname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot Temperature and Energy as a function of time with their cumulative sum and average.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        process : sarkas.processes.PostProcess</span>
<span class="sd">            Sarkas Process.</span>

<span class="sd">        phase: str</span>
<span class="sd">            Phase to plot. &quot;equilibration&quot; or &quot;production&quot;.</span>

<span class="sd">        show: bool</span>
<span class="sd">            Flag for displaying the figure.</span>

<span class="sd">        publication: bool</span>
<span class="sd">            Flag for publication style plotting.</span>

<span class="sd">        figname: str</span>
<span class="sd">            Name with which to save the plot.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;equilibration&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eq_no_dumps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eq_dump_dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eq_dump_step</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_steps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_no_dumps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_dump_dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_dump_step</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">production_dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">production_steps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;magnetization&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_no_dumps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_dump_dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_dump_step</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnetization_dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnetization_steps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

        <span class="n">completed_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">fsz</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="k">if</span> <span class="n">publication</span><span class="p">:</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;PUBstyle&#39;</span><span class="p">)</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

            <span class="c1"># Temperature plots</span>
            <span class="n">T_delta_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">T_main_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">T_hist_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
            <span class="c1"># Energy plots</span>
            <span class="n">E_delta_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
            <span class="n">E_main_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
            <span class="n">E_hist_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

            <span class="n">Info_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
            <span class="c1"># Temperature plots</span>
            <span class="n">T_delta_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">T_main_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">T_hist_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
            <span class="c1"># Energy plots</span>
            <span class="n">E_delta_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
            <span class="n">E_main_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
            <span class="n">E_hist_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
        <span class="c1"># Grab the current rcParams so that I can restore it later</span>
        <span class="n">current_rcParams</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Update rcParams with the necessary values</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fsz</span><span class="p">)</span>  <span class="c1"># controls default text sizes</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">titlesize</span><span class="o">=</span><span class="n">fsz</span><span class="p">)</span>  <span class="c1"># fontsize of the axes title</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fsz</span><span class="p">)</span>  <span class="c1"># fontsize of the x and y labels</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fsz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># fontsize of the tick labels</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fsz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># fontsize of the tick labels</span>

        <span class="c1"># Grab the color line list from the plt cycler. I will used this in the hist plots</span>
        <span class="n">color_from_cycler</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.prop_cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>

        <span class="c1"># ------------------------------------------- Temperature -------------------------------------------#</span>
        <span class="c1"># Calculate Temperature plot&#39;s labels and multipliers</span>
        <span class="n">time_mul</span><span class="p">,</span> <span class="n">temp_mul</span><span class="p">,</span> <span class="n">time_prefix</span><span class="p">,</span> <span class="n">temp_prefix</span><span class="p">,</span> <span class="n">time_lbl</span><span class="p">,</span> <span class="n">temp_lbl</span> <span class="o">=</span> <span class="n">plot_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">],</span>
                                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Temperature&quot;</span><span class="p">],</span>
                                                                                       <span class="s2">&quot;Time&quot;</span><span class="p">,</span>
                                                                                       <span class="s2">&quot;Temperature&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="c1"># Rescale quantities</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time_mul</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span>
        <span class="n">Temperature</span> <span class="o">=</span> <span class="n">temp_mul</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Temperature&quot;</span><span class="p">]</span>
        <span class="n">T_desired</span> <span class="o">=</span> <span class="n">temp_mul</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_desired</span>

        <span class="c1"># Temperature moving average</span>
        <span class="n">T_cumavg</span> <span class="o">=</span> <span class="n">Temperature</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Temperature deviation and its moving average</span>
        <span class="n">Delta_T</span> <span class="o">=</span> <span class="p">(</span><span class="n">Temperature</span> <span class="o">-</span> <span class="n">T_desired</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">T_desired</span>
        <span class="n">Delta_T_cum_avg</span> <span class="o">=</span> <span class="n">Delta_T</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Temperature Main plot</span>
        <span class="n">T_main_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">Temperature</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">T_main_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">T_cumavg</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Moving Average&#39;</span><span class="p">)</span>
        <span class="n">T_main_plot</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">T_desired</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Desired T&#39;</span><span class="p">)</span>
        <span class="n">T_main_plot</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        <span class="n">T_main_plot</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Temperature&quot;</span> <span class="o">+</span> <span class="n">temp_lbl</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time&quot;</span> <span class="o">+</span> <span class="n">time_lbl</span><span class="p">)</span>

        <span class="c1"># Temperature Deviation plot</span>
        <span class="n">T_delta_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">Delta_T</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">T_delta_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">Delta_T_cum_avg</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">T_delta_plot</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Deviation [%]&#39;</span><span class="p">)</span>

        <span class="c1"># This was a failed attempt to calculate the theoretical Temperature distribution.</span>
        <span class="c1"># Gaussian</span>
        <span class="n">T_dist</span> <span class="o">=</span> <span class="n">scp_stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">T_desired</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">Temperature</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
        <span class="c1"># Histogram plot</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">Temperature</span><span class="p">,</span>
                     <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                     <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;density&#39;</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
                     <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                     <span class="n">ax</span><span class="o">=</span><span class="n">T_hist_plot</span><span class="p">)</span>
        <span class="n">T_hist_plot</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">T_hist_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T_dist</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">Temperature</span><span class="p">),</span> <span class="n">Temperature</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_from_cycler</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># ------------------------------------------- Total Energy -------------------------------------------#</span>
        <span class="c1"># Calculate Energy plot&#39;s labels and multipliers</span>
        <span class="n">time_mul</span><span class="p">,</span> <span class="n">energy_mul</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">time_lbl</span><span class="p">,</span> <span class="n">energy_lbl</span> <span class="o">=</span> <span class="n">plot_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">],</span>
                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Total Energy&quot;</span><span class="p">],</span>
                                                                       <span class="s2">&quot;Time&quot;</span><span class="p">,</span>
                                                                       <span class="s2">&quot;Energy&quot;</span><span class="p">,</span>
                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>

        <span class="n">Energy</span> <span class="o">=</span> <span class="n">energy_mul</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Total Energy&quot;</span><span class="p">]</span>
        <span class="c1"># Total Energy moving average</span>
        <span class="n">E_cumavg</span> <span class="o">=</span> <span class="n">Energy</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="c1"># Total Energy Deviation and its moving average</span>
        <span class="n">Delta_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">Energy</span> <span class="o">-</span> <span class="n">Energy</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">Energy</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Delta_E_cum_avg</span> <span class="o">=</span> <span class="n">Delta_E</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Energy main plot</span>
        <span class="n">E_main_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">E_main_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">E_cumavg</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Moving Average&#39;</span><span class="p">)</span>
        <span class="n">E_main_plot</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">Energy</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Avg&#39;</span><span class="p">)</span>
        <span class="n">E_main_plot</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        <span class="n">E_main_plot</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Total Energy&quot;</span> <span class="o">+</span> <span class="n">energy_lbl</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time&quot;</span> <span class="o">+</span> <span class="n">time_lbl</span><span class="p">)</span>

        <span class="c1"># Deviation Plot</span>
        <span class="n">E_delta_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">Delta_E</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">E_delta_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">Delta_E_cum_avg</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">E_delta_plot</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Deviation [%]&#39;</span><span class="p">)</span>

        <span class="c1"># (Failed) Attempt to calculate the theoretical Energy distribution</span>
        <span class="c1"># In an NVT ensemble Energy fluctuation are given by sigma(E) = sqrt( k_B T^2 C_v)</span>
        <span class="c1"># where C_v is the isothermal heat capacity</span>
        <span class="c1"># Since this requires a lot of prior calculation I skip it and just make a Gaussian</span>
        <span class="n">E_dist</span> <span class="o">=</span> <span class="n">scp_stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">Energy</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">scale</span><span class="o">=</span><span class="n">Energy</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
        <span class="c1"># Histogram plot</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">Energy</span><span class="p">,</span>
                     <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                     <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;density&#39;</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
                     <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;False&#39;</span><span class="p">,</span>
                     <span class="n">ax</span><span class="o">=</span><span class="n">E_hist_plot</span><span class="p">)</span>
        <span class="c1"># Grab the second color since the first is used for histplot</span>
        <span class="n">E_hist_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_dist</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">Energy</span><span class="p">),</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_from_cycler</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">E_hist_plot</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">publication</span><span class="p">:</span>
            <span class="n">dt_mul</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dt_lbl</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plot_labels</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Total Energy&quot;</span><span class="p">],</span>
                                                     <span class="s2">&quot;Time&quot;</span><span class="p">,</span>
                                                     <span class="s2">&quot;Energy&quot;</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
            <span class="c1"># Information section</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;Job ID: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">,</span> <span class="s2">&quot;Phase: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">,</span> <span class="s2">&quot;No. of species = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">)))</span>
            <span class="n">y_coord</span> <span class="o">=</span> <span class="mf">8.5</span>
            <span class="k">for</span> <span class="n">isp</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
                <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span><span class="p">,</span> <span class="s2">&quot;Species </span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;  No. of particles = </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">num</span><span class="p">))</span>
                <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">,</span>
                               <span class="s2">&quot;  Temperature = </span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_mul</span> <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">temp_lbl</span><span class="p">))</span>
                <span class="n">y_coord</span> <span class="o">-=</span> <span class="mf">1.5</span>

            <span class="n">y_coord</span> <span class="o">-=</span> <span class="mf">0.25</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span><span class="p">,</span> <span class="s2">&quot;Total $N$ = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">total_num_ptcls</span><span class="p">))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;Thermostat: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">thermostat</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">,</span> <span class="s2">&quot;Berendsen rate = </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">thermostat</span><span class="o">.</span><span class="n">relaxation_rate</span><span class="p">))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s2">&quot;Potential: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">2.</span><span class="p">,</span> <span class="s2">&quot;Tot Force Error = </span><span class="si">{:.2e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">force_error</span><span class="p">))</span>
            <span class="n">delta_t</span> <span class="o">=</span> <span class="n">dt_mul</span> <span class="o">*</span> <span class="n">process</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">dt</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">2.5</span><span class="p">,</span> <span class="s2">&quot;$\Delta t$ = </span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">dt_lbl</span><span class="p">))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">3.</span><span class="p">,</span> <span class="s2">&quot;Step interval = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">3.5</span><span class="p">,</span>
                           <span class="s2">&quot;Step interval time = </span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span> <span class="o">*</span> <span class="n">delta_t</span><span class="p">,</span> <span class="n">dt_lbl</span><span class="p">))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">4.</span><span class="p">,</span> <span class="s2">&quot;Completed steps = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">completed_steps</span><span class="p">))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">4.5</span><span class="p">,</span>
                           <span class="s2">&quot;Completed time = </span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">completed_steps</span> <span class="o">*</span> <span class="n">delta_t</span> <span class="o">/</span> <span class="n">dt_mul</span> <span class="o">*</span> <span class="n">time_mul</span><span class="p">,</span> <span class="n">time_lbl</span><span class="p">))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">5.</span><span class="p">,</span> <span class="s2">&quot;Total timesteps = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_steps</span><span class="p">))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">5.5</span><span class="p">,</span>
                           <span class="s2">&quot;Total time = </span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_steps</span> <span class="o">*</span> <span class="n">delta_t</span> <span class="o">/</span> <span class="n">dt_mul</span> <span class="o">*</span> <span class="n">time_mul</span><span class="p">,</span> <span class="n">time_lbl</span><span class="p">))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y_coord</span> <span class="o">-</span> <span class="mf">6.</span><span class="p">,</span>
                           <span class="s2">&quot;</span><span class="si">{:1.2f}</span><span class="s2"> % Completed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">completed_steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_steps</span><span class="p">))</span>
            <span class="n">Info_plot</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">publication</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># Saving</span>
        <span class="k">if</span> <span class="n">figname</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="n">figname</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s1">&#39;Plot_EnsembleCheck_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Restore the previous rcParams</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span> <span class="o">=</span> <span class="n">current_rcParams</span></div></div>


<div class="viewcode-block" id="VelocityAutoCorrelationFunction"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.VelocityAutoCorrelationFunction">[docs]</a><span class="k">class</span> <span class="nc">VelocityAutoCorrelationFunction</span><span class="p">(</span><span class="n">Observable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Velocity Auto-correlation function.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="VelocityAutoCorrelationFunction.setup"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.VelocityAutoCorrelationFunction.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">no_slices</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign attributes from simulation&#39;s parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        no_slices : int</span>
<span class="sd">            Number of independent runs inside a long simulation. Default = 1.</span>

<span class="sd">        phase : str</span>
<span class="sd">            Phase to compute. Default = &#39;production&#39;.</span>

<span class="sd">        params : sarkas.base.Parameters</span>
<span class="sd">            Simulation&#39;s parameters.</span>

<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">no_slices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span> <span class="o">=</span> <span class="n">no_slices</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_init</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;vacf&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">=</span> <span class="s1">&#39;Velocity AutoCorrelation Function&#39;</span>

        <span class="c1"># Create the directory where to store the computed data</span>
        <span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postprocessing_dir</span><span class="p">,</span> <span class="s1">&#39;VelocityAutoCorrelationFunction&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s2">&quot;VelocityACF_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></div>
        <span class="c1">#</span>

<div class="viewcode-block" id="VelocityAutoCorrelationFunction.compute"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.VelocityAutoCorrelationFunction.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the velocity auto-correlation functions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Recalculate the slicing parameters if no_slices has been passed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">)</span>

        <span class="n">start_slice</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">end_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">)</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating vacf for slice </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">))</span>
            <span class="c1"># Parse the particles from the dump files</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_num_ptcls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">))</span>
            <span class="c1">#</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parsing particles&#39; velocities.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">dump</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_slice</span><span class="p">,</span> <span class="n">end_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)):</span>
                <span class="n">datap</span> <span class="o">=</span> <span class="n">load_from_restart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span><span class="p">,</span> <span class="n">dump</span><span class="p">)</span>
                <span class="n">time</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
                <span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">vel</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">isl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>

            <span class="c1"># Return an array of shape( num_species, dim + 1, slice_steps)</span>
            <span class="n">vacf</span> <span class="o">=</span> <span class="n">calc_vacf</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> X Velocity ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">isl</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vacf</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Y Velocity ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">isl</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vacf</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Z Velocity ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">isl</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vacf</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Total Velocity ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">isl</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vacf</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>

            <span class="n">start_slice</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span>
            <span class="n">end_slice</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span>

        <span class="c1"># Average the stuff</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
            <span class="n">xcol_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> X Velocity ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">isl</span><span class="p">)</span> <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">)]</span>
            <span class="n">ycol_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Y Velocity ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">isl</span><span class="p">)</span> <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">)]</span>
            <span class="n">zcol_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Z Velocity ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">isl</span><span class="p">)</span> <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">)]</span>
            <span class="n">tot_col_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Total Velocity ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">isl</span><span class="p">)</span> <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">)]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> X Velocity ACF avg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">xcol_str</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> X Velocity ACF std&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">xcol_str</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Y Velocity ACF avg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">ycol_str</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Y Velocity ACF std&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">ycol_str</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Z Velocity ACF avg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">zcol_str</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Z Velocity ACF std&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">zcol_str</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Total Velocity ACF avg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">tot_col_str</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Total Velocity ACF std&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">tot_col_str</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">(</span><span class="s2">&quot;VACF Calculation&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">time_division</span><span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span></div>

<div class="viewcode-block" id="VelocityAutoCorrelationFunction.pretty_print"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.VelocityAutoCorrelationFunction.pretty_print">[docs]</a>    <span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print observable parameters for help in choice of simulation parameters.&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="si">{:=^70}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data saved in: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data accessible at: self.dataframe&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No. of slices = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. dumps per slice = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time interval of autocorrelation function = </span><span class="si">{:.4e}</span><span class="s1"> [s] ~ </span><span class="si">{}</span><span class="s1"> w_p T&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">,</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plasma_frequency</span><span class="p">)))</span></div></div>


<div class="viewcode-block" id="FluxAutoCorrelationFunction"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.FluxAutoCorrelationFunction">[docs]</a><span class="k">class</span> <span class="nc">FluxAutoCorrelationFunction</span><span class="p">(</span><span class="n">Observable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Species Diffusion Flux Auto-correlation function.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FluxAutoCorrelationFunction.setup"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.FluxAutoCorrelationFunction.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">no_slices</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign attributes from simulation&#39;s parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phase : str</span>
<span class="sd">            Phase to compute. Default = &#39;production&#39;.</span>

<span class="sd">        params : sarkas.base.Parameters</span>
<span class="sd">            Simulation&#39;s parameters.</span>

<span class="sd">        no_slices : int</span>
<span class="sd">            Number of independent runs inside a long simulation. Default = 1.</span>

<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">no_slices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span> <span class="o">=</span> <span class="n">no_slices</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_init</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;facf&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">=</span> <span class="s1">&#39;Flux AutoCorrelation Function&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;species_mass_densities&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_mass_densities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_num_dens</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_masses</span>

        <span class="c1"># Create the directory where to store the computed data</span>
        <span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postprocessing_dir</span><span class="p">,</span> <span class="s1">&#39;DiffusionFluxAutoCorrelationFunction&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s2">&quot;DiffusionFluxACF_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></div>

<div class="viewcode-block" id="FluxAutoCorrelationFunction.compute"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.FluxAutoCorrelationFunction.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the velocity auto-correlation functions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Update the attribute with the passed arguments. e.g time_averaging and timesteps_to_skip</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Recalculate the slicing parameters if no_slices has been passed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">)</span>

        <span class="n">start_slice</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">end_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">)</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating diffusion flux acf for slice </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">))</span>
            <span class="c1"># Parse the particles from the dump files</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_num_ptcls</span><span class="p">))</span>
            <span class="c1">#</span>
            <span class="c1"># print(&quot;\nParsing particles&#39; velocities.&quot;)</span>
            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">dump</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_slice</span><span class="p">,</span> <span class="n">end_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">),</span>
                                           <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Read in data&#39;</span><span class="p">,</span>
                                           <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)):</span>
                <span class="n">datap</span> <span class="o">=</span> <span class="n">load_from_restart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span><span class="p">,</span> <span class="n">dump</span><span class="p">)</span>
                <span class="n">time</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
                <span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">vel</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">isl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>

            <span class="n">df_acf</span> <span class="o">=</span> <span class="n">calc_diff_flux_acf</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">species_num_dens</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">species_masses</span><span class="p">)</span>

            <span class="c1"># Store the data</span>
            <span class="n">v_ij</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">sp2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">i</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> X Diffusion Flux ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">,</span> <span class="n">isl</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_acf</span><span class="p">[</span><span class="n">v_ij</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> Y Diffusion Flux ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">,</span> <span class="n">isl</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_acf</span><span class="p">[</span><span class="n">v_ij</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> Z Diffusion Flux ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">,</span> <span class="n">isl</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_acf</span><span class="p">[</span><span class="n">v_ij</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> Total Diffusion Flux ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">,</span> <span class="n">isl</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_acf</span><span class="p">[</span><span class="n">v_ij</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">v_ij</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">start_slice</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span>
            <span class="n">end_slice</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span>

        <span class="c1"># Average</span>
        <span class="n">v_ij</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">sp2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">i</span><span class="p">):</span>
                <span class="n">xcol_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> X Diffusion Flux ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">,</span> <span class="n">isl</span><span class="p">)</span> <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span>
                            <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">)]</span>
                <span class="n">ycol_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> Y Diffusion Flux ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">,</span> <span class="n">isl</span><span class="p">)</span> <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span>
                            <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">)]</span>
                <span class="n">zcol_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> Z Diffusion Flux ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">,</span> <span class="n">isl</span><span class="p">)</span> <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span>
                            <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">)]</span>
                <span class="n">tot_col_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> Total Diffusion Flux ACF slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">,</span> <span class="n">isl</span><span class="p">)</span> <span class="k">for</span> <span class="n">isl</span> <span class="ow">in</span>
                               <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">)]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> X Diffusion Flux ACF avg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">xcol_str</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> X Diffusion Flux ACF std&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">xcol_str</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> Y Diffusion Flux ACF avg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">ycol_str</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> Y Diffusion Flux ACF std&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">ycol_str</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> Z Diffusion Flux ACF avg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">zcol_str</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> Z Diffusion Flux ACF std&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">zcol_str</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> Total Diffusion Flux ACF avg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span>
                    <span class="n">tot_col_str</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> Total Diffusion Flux ACF std&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span>
                    <span class="n">tot_col_str</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">v_ij</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">(</span><span class="s2">&quot;Diffusion Flux ACF Calculation&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">time_division</span><span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span></div>

<div class="viewcode-block" id="FluxAutoCorrelationFunction.pretty_print"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.FluxAutoCorrelationFunction.pretty_print">[docs]</a>    <span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print observable parameters for help in choice of simulation parameters.&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="si">{:=^70}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data saved in: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data accessible at: self.dataframe&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No. of slices = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_slices</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. dumps per slice = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time interval of autocorrelation function = </span><span class="si">{:.4e}</span><span class="s1"> [s] ~ </span><span class="si">{}</span><span class="s1"> w_p T&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span><span class="p">,</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plasma_frequency</span><span class="p">)))</span></div></div>


<div class="viewcode-block" id="VelocityDistribution"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.VelocityDistribution">[docs]</a><span class="k">class</span> <span class="nc">VelocityDistribution</span><span class="p">(</span><span class="n">Observable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Moments of the velocity distributions defined as</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\langle v^{\\alpha} \\rangle = \\int_{-\\infty}^{\\infty} d v \, f(v) v^{2 \\alpha}.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    no_bins: int</span>
<span class="sd">        Number of bins used to calculate the velocity distribution.</span>

<span class="sd">    plots_dir: str</span>
<span class="sd">        Directory in which to store Hermite coefficients plots.</span>

<span class="sd">    species_plots_dirs : list, str</span>
<span class="sd">        Directory for each species where to save Hermite coefficients plots.</span>

<span class="sd">    max_no_moment: int</span>
<span class="sd">        Maximum number of moments = :math:`\alpha`. Default = 3.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="VelocityDistribution.setup"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.VelocityDistribution.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">params</span><span class="p">,</span>
              <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">hist_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">max_no_moment</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
              <span class="n">curve_fit_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign attributes from simulation&#39;s parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        curve_fit_kwargs</span>
<span class="sd">        hist_kwargs : dict, optional</span>
<span class="sd">            Dictionary of keyword arguments to pass to ``np.histogram`` for the calculation of the distributions.</span>

<span class="sd">        phase : str</span>
<span class="sd">            Phase to compute. Default = &#39;production&#39;.</span>

<span class="sd">        max_no_moment : int</span>
<span class="sd">            Maximum number of moments to calculate. Default = 6.</span>

<span class="sd">        params : sarkas.base.Parameters</span>
<span class="sd">            Simulation&#39;s parameters.</span>

<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">curve_fit_kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curve_fit_kwargs</span> <span class="o">=</span> <span class="n">curve_fit_kwargs</span>

        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_init</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;vd&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">=</span> <span class="s1">&#39;Velocity Distribution&#39;</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="c1"># Check on hist_kwargs</span>
        <span class="k">if</span> <span class="n">hist_kwargs</span><span class="p">:</span>
            <span class="c1"># Is it a dictionary ?</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hist_kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s1">&#39;hist_kwargs not a dictionary. Please pass a dictionary.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span> <span class="o">=</span> <span class="n">hist_kwargs</span>
        <span class="c1"># Default number of moments to calculate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_no_moment</span> <span class="o">=</span> <span class="n">max_no_moment</span>

        <span class="c1"># Create the directory where to store the computed data</span>
        <span class="c1"># First the name of the observable</span>
        <span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postprocessing_dir</span><span class="p">,</span> <span class="s1">&#39;VelocityDistribution&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">)</span>
        <span class="c1"># then the phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">adjusted_dump_dir</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_run_average</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runs</span><span class="p">):</span>
                <span class="c1"># Direct to the correct dumps directory</span>
                <span class="n">dump_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;run</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;Simulation&#39;</span><span class="p">,</span>
                                                                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span> <span class="s1">&#39;dumps&#39;</span><span class="p">)))</span>
                <span class="n">dump_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulations_dir</span><span class="p">,</span> <span class="n">dump_dir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adjusted_dump_dir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dump_dir</span><span class="p">)</span>
            <span class="c1"># Re-path the saving directory</span>
            <span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulations_dir</span><span class="p">,</span> <span class="s1">&#39;PostProcessing&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">)</span>
            <span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s1">&#39;VelocityDistribution&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adjusted_dump_dir</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_dir</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">)</span>

        <span class="c1"># Directories in which to store plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s1">&#39;Plots&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plots_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plots_dir</span><span class="p">)</span>

        <span class="c1"># Paths where to store the dataframes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_run_average</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s2">&quot;VelocityDistribution.csv&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s2">&quot;VelocityDistribution.h5&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s2">&quot;VelocityDistribution_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s2">&quot;VelocityDistribution_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;max_no_moment&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moments_dataframe</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mom_df_filename_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s2">&quot;Moments_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;max_hermite_order&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hermite_dataframe</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">herm_df_filename_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="s2">&quot;HermiteCoefficients_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
            <span class="c1"># some checks</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;hermite_rms_tol&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hermite_rms_tol</span> <span class="o">=</span> <span class="mf">0.05</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">species_plots_dirs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Need this for pretty print</span>
        <span class="c1"># Calculate the dimension of the velocity container</span>
        <span class="c1"># 2nd Dimension of the raw velocity array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensional_average</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span>
        <span class="c1"># range(inv_dim) for the loop over dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inv_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensional_average</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="c1"># Array containing the start index of each species. The last value is equivalent to vel_raw.shape[-1]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_index_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_dim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs</span>

        <span class="c1"># Check if arguments have been passed</span>
        <span class="k">if</span> <span class="n">hist_kwargs</span><span class="p">:</span>
            <span class="c1"># Did you pass a single dictionary for multispecies?</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">hist_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># The elements of hist_kwargs should be lists</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hist_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">hist_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">)]</span>

            <span class="c1"># Override whatever was passed via YAML or setup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hist_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_histogram_args</span><span class="p">()</span></div>

<div class="viewcode-block" id="VelocityDistribution.grab_sim_data"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.VelocityDistribution.grab_sim_data">[docs]</a>    <span class="k">def</span> <span class="nf">grab_sim_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read in velocity data&quot;&quot;&quot;</span>

        <span class="c1"># Velocity array for storing simulation data</span>
        <span class="n">vel_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_dim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_num_ptcls</span><span class="p">))</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Collecting data from snapshots ...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensional_average</span><span class="p">:</span>
            <span class="c1"># Loop over the runs</span>
            <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">dump_dir_r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjusted_dump_dir</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Runs Loop&#39;</span><span class="p">)):</span>
                <span class="c1"># Loop over the timesteps</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Timestep Loop&#39;</span><span class="p">):</span>
                    <span class="c1"># Read data from file</span>
                    <span class="n">dump</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">it</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>
                    <span class="n">datap</span> <span class="o">=</span> <span class="n">load_from_restart</span><span class="p">(</span><span class="n">dump_dir_r</span><span class="p">,</span> <span class="n">dump</span><span class="p">)</span>
                    <span class="c1"># Loop over the particles&#39; species</span>
                    <span class="k">for</span> <span class="n">sp_indx</span><span class="p">,</span> <span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">sp_num</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">)):</span>
                        <span class="c1"># Calculate the correct start and end index for storage</span>
                        <span class="n">start_indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_index_start</span><span class="p">[</span><span class="n">sp_indx</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_dim</span> <span class="o">*</span> <span class="n">sp_num</span> <span class="o">*</span> <span class="n">r</span>
                        <span class="n">end_indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_index_start</span><span class="p">[</span><span class="n">sp_indx</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_dim</span> <span class="o">*</span> <span class="n">sp_num</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="c1"># Use a mask to grab only the selected species and flatten along the first axis</span>
                        <span class="c1"># data = ( v1_x, v1_y, v1_z,</span>
                        <span class="c1">#          v2_x, v2_y, v2_z,</span>
                        <span class="c1">#          v3_x, v3_y, v3_z,</span>
                        <span class="c1">#          ...)</span>
                        <span class="c1"># The flatten array would like this</span>
                        <span class="c1"># flattened = ( v1_x, v2_x, v3_x, ..., v1_y, v2_y, v3_y, ..., v1_z, v2_z, v3_z, ...)</span>
                        <span class="n">vel_raw</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">start_indx</span><span class="p">:</span> <span class="n">end_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][</span><span class="n">datap</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sp_name</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

                    <span class="n">time</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Dimensional Average = False</span>
            <span class="c1"># Loop over the runs</span>
            <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">dump_dir_r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjusted_dump_dir</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Runs Loop&#39;</span><span class="p">)):</span>
                <span class="c1"># Loop over the timesteps</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Timestep Loop&#39;</span><span class="p">):</span>
                    <span class="c1"># Read data from file</span>
                    <span class="n">dump</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">it</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_step</span><span class="p">)</span>
                    <span class="n">datap</span> <span class="o">=</span> <span class="n">load_from_restart</span><span class="p">(</span><span class="n">dump_dir_r</span><span class="p">,</span> <span class="n">dump</span><span class="p">)</span>
                    <span class="c1"># Loop over the particles&#39; species</span>
                    <span class="k">for</span> <span class="n">sp_indx</span><span class="p">,</span> <span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">sp_num</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">)):</span>
                        <span class="c1"># Calculate the correct start and end index for storage</span>
                        <span class="n">start_indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_index_start</span><span class="p">[</span><span class="n">sp_indx</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_dim</span> <span class="o">*</span> <span class="n">sp_num</span> <span class="o">*</span> <span class="n">r</span>
                        <span class="n">end_indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_index_start</span><span class="p">[</span><span class="n">sp_indx</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_dim</span> <span class="o">*</span> <span class="n">sp_num</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="c1"># Use a mask to grab only the selected species and transpose the array to put dimensions first</span>
                        <span class="n">vel_raw</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="p">:,</span> <span class="n">start_indx</span><span class="p">:</span> <span class="n">end_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">][</span><span class="n">datap</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sp_name</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

                <span class="n">time</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">datap</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">time</span><span class="p">,</span> <span class="n">vel_raw</span></div>

<div class="viewcode-block" id="VelocityDistribution.compute"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.VelocityDistribution.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hist_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the moments of the velocity distributions and save them to a pandas dataframes and csv.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hist_kwargs : dict, optional</span>
<span class="sd">            Dictionary with arguments to pass to ``numpy.histogram``.</span>

<span class="sd">        **kwargs :</span>
<span class="sd">            These are will overwrite any ``sarkas.base.Parameters`` or default ``sarkas.tools.observables.Observable``</span>
<span class="sd">            attributes and/or add new ones.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Update the attribute with the passed arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Check if arguments have been passed</span>
        <span class="k">if</span> <span class="n">hist_kwargs</span><span class="p">:</span>
            <span class="c1"># Did you pass a single dictionary for multispecies?</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">hist_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># The elements of hist_kwargs should be lists</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hist_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">hist_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">)]</span>

            <span class="c1"># Override whatever was passed via YAML or setup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hist_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Make the histogram arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_histogram_args</span><span class="p">()</span>

        <span class="c1"># Print info to screen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>

        <span class="c1"># Ok let&#39;s do it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Calculate the dimension of the velocity container</span>

        <span class="c1"># 2nd Dimension of the raw velocity array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensional_average</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span>
        <span class="c1"># range(inv_dim) for the loop over dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inv_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensional_average</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="c1"># Array containing the start index of each species. The last value is equivalent to vel_raw.shape[-1]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_index_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_dim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs</span>

        <span class="c1"># Grab simulation data</span>
        <span class="n">time</span><span class="p">,</span> <span class="n">vel_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grab_sim_data</span><span class="p">()</span>

        <span class="c1"># Make the velocity distribution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_distribution</span><span class="p">(</span><span class="n">vel_raw</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

        <span class="c1"># Calculate velocity moments</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;max_no_moment&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_moments</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">vel_raw</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;max_hermite_order&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_hermite_expansion</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="VelocityDistribution.prepare_histogram_args"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.VelocityDistribution.prepare_histogram_args">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_histogram_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Initialize histograms arguments</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;hist_kwargs&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;density&#39;</span><span class="p">:</span> <span class="p">[],</span>
                                <span class="s1">&#39;bins&#39;</span><span class="p">:</span> <span class="p">[],</span>
                                <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="p">[]</span>
                                <span class="p">}</span>
        <span class="c1"># Default values</span>
        <span class="n">bin_width</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="c1"># Range of the histogram = (-wid * vth, wid * vth)</span>
        <span class="n">wid</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="c1"># The number of bins is calculated from default values of bin_width and wid</span>
        <span class="n">no_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">wid</span> <span class="o">/</span> <span class="n">bin_width</span><span class="p">)</span>
        <span class="c1"># Calculate thermal speed from energy/temperature data.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">energy_fle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_energy_filename</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">eq_energy_filename</span>
            <span class="n">energy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">energy_fle</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_species</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">vth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="p">(</span><span class="n">sp_mass</span><span class="p">,</span> <span class="n">sp_name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_masses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">)):</span>
                    <span class="n">vth</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">energy_df</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Temperature&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kB</span> <span class="o">/</span> <span class="n">sp_mass</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">energy_df</span><span class="p">[</span><span class="s2">&quot;Temperature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kB</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_masses</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">vth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kB</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_desired</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_masses</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">vth</span><span class="p">)</span>

        <span class="c1"># Create the default dictionary of histogram args</span>
        <span class="n">default_hist_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;density&#39;</span><span class="p">:</span> <span class="p">[],</span>
                               <span class="s1">&#39;bins&#39;</span><span class="p">:</span> <span class="p">[],</span>
                               <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_species</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">):</span>
                <span class="n">default_hist_kwargs</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">default_hist_kwargs</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">no_bins</span><span class="p">)</span>
                <span class="n">default_hist_kwargs</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">wid</span> <span class="o">*</span> <span class="n">vth</span><span class="p">[</span><span class="n">sp</span><span class="p">],</span> <span class="n">wid</span> <span class="o">*</span> <span class="n">vth</span><span class="p">[</span><span class="n">sp</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_hist_kwargs</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">default_hist_kwargs</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">no_bins</span><span class="p">)</span>
            <span class="n">default_hist_kwargs</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">wid</span> <span class="o">*</span> <span class="n">vth</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wid</span> <span class="o">*</span> <span class="n">vth</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Now do some checks.</span>
        <span class="c1"># Check for numpy.histogram args in kwargs</span>
        <span class="n">must_have_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="s1">&#39;density&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">must_have_keys</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Is it empty?</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_hist_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_hist_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Ok at this point I have a dictionary whose elements are list.</span>
        <span class="c1"># I want the inverse a list whose elements are dicts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_hist_kwargs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">):</span>
            <span class="n">another_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Loop over the keys and grab the species value</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">another_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">list_hist_kwargs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">another_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="VelocityDistribution.create_distribution"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.VelocityDistribution.create_distribution">[docs]</a>    <span class="k">def</span> <span class="nf">create_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vel_raw</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the velocity distribution of each species and save the corresponding dataframes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vel_raw: np.ndarray, optional</span>
<span class="sd">            Container of particles velocity at each time step.</span>

<span class="sd">        time: np.ndarray, optional</span>
<span class="sd">            Time array.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Creating velocity distributions ...&quot;</span><span class="p">)</span>
        <span class="n">tinit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="n">no_dumps</span> <span class="o">=</span> <span class="n">vel_raw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">no_dim</span> <span class="o">=</span> <span class="n">vel_raw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># I want a Hierarchical dataframe</span>
        <span class="c1"># Example:</span>
        <span class="c1">#   Ca	                        Yb	    Ca	                        Yb	    Ca	                        Yb</span>
        <span class="c1">#   X	                        X	    Y	                        Y	    Z	                        Z</span>
        <span class="c1">#   1.54e-03 -2.54e+22 3.54e+00	1 2     1.54e-03 -2.54e+22 3.54e+00	1 2	    1.54e-03 -2.54e+22 3.54e+00 1 2</span>
        <span class="c1"># This has 3 rows of columns. The first identifies the species, The second the axis,</span>
        <span class="c1"># and the third the value of the bin_edge</span>
        <span class="c1"># This can be easily obtained from pandas dataframe MultiIndex. But first I will create a dataframe</span>
        <span class="c1"># from a huge matrix. The columns of this dataframe will be</span>
        <span class="c1"># Ca_X_1.54e-03 Ca_X_-2.54e+22 Ca_X_3.54e+00 Yb_X_1	Yb_X_2 Ca_Y_1.54e-03 Ca_Y_-2.54e+22 Ca_Y_3.54e+00 Yb_Y_1 ...</span>
        <span class="c1"># using pd.MultiIndex.from_tuples([tuple(c.split(&quot;_&quot;)) for c in df.columns]) I can create a hierarchical df.</span>
        <span class="c1"># This is because I can access the data as</span>
        <span class="c1"># df[&#39;Ca&#39;][&#39;X&#39;]</span>
        <span class="c1"># &gt;&gt;&gt;       1.54e-03	-2.54e+22	3.54e+00</span>
        <span class="c1"># &gt;&gt;&gt; Time</span>
        <span class="c1"># &gt;&gt;&gt;   0   -1.694058	1.217008	-0.260678</span>
        <span class="c1"># with the index = to my time array.</span>
        <span class="c1"># see https://pandas.pydata.org/pandas-docs/stable/user_guide/advanced.html#reconstructing-the-level-labels</span>

        <span class="c1"># Columns</span>

        <span class="n">full_df_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># At the first time step I will create the columns list.</span>
        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_kwargs</span><span class="p">[</span><span class="s2">&quot;bins&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">)))</span>
        <span class="c1"># The +1 at the end is because I decided to add a column containing the timestep</span>
        <span class="c1"># For convenience save the bin edges somewhere else. The columns of the dataframe are string. This will give</span>
        <span class="c1"># problems when plotting.</span>
        <span class="c1"># Use a dictionary since the arrays could be different lengths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_bin_edges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">:</span>
            <span class="c1"># Initialize the sub-dictionary</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_bin_edges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_dumps</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">no_dim</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">]):</span>
                <span class="n">indx_0</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">sp_start</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_index_start</span><span class="p">)):</span>
                    <span class="c1"># Calculate the correct start and end index for storage</span>
                    <span class="n">sp_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_index_start</span><span class="p">[</span><span class="n">indx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

                    <span class="n">bin_count</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">vel_raw</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">sp_start</span><span class="p">:</span><span class="n">sp_end</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">list_hist_kwargs</span><span class="p">[</span><span class="n">indx</span><span class="p">])</span>

                    <span class="c1"># Executive decision: Center the bins</span>
                    <span class="n">bin_loc</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="c1"># Create the second_column_row the dataframe</span>
                    <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Create the column array</span>
                        <span class="n">full_df_columns</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_Time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">ds</span><span class="p">)])</span>
                        <span class="n">full_df_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{:6e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">be</span><span class="p">)</span> <span class="k">for</span> <span class="n">be</span> <span class="ow">in</span> <span class="n">bin_loc</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_bin_edges</span><span class="p">[</span><span class="n">sp_name</span><span class="p">][</span><span class="n">ds</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_edges</span>
                        <span class="c1"># Ok. Now I have created the bins columns&#39; names</span>
                    <span class="c1"># Time to insert in the huge matrix.</span>
                    <span class="n">indx_1</span> <span class="o">=</span> <span class="n">indx_0</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_count</span><span class="p">)</span>
                    <span class="n">dist_matrix</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="n">indx_0</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
                    <span class="n">dist_matrix</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="n">indx_0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">indx_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_count</span>
                    <span class="n">indx_0</span> <span class="o">=</span> <span class="n">indx_1</span>
        <span class="c1"># Alright. The matrix is filled now onto the dataframe</span>
        <span class="c1"># First let&#39;s flatten the columns array. This is because I have something like this</span>
        <span class="c1"># Example: Binary Mixture with 3 H bins per axis and 2 He bins per axis</span>
        <span class="c1"># columns =[[&#39;H_X&#39;, &#39;H_X&#39;, &#39;H_X&#39;], [&#39;He_X&#39;, &#39;He_X&#39;], [&#39;H_Y&#39;, &#39;H_Y&#39;, &#39;H_Y&#39;], [&#39;He_Y&#39;, &#39;He_Y&#39;] ... Z-axis]</span>
        <span class="c1"># Flatten with list(np.concatenate(columns).flat)</span>
        <span class="c1"># Now has become</span>
        <span class="c1"># first_column_row=[&#39;H_X&#39;, &#39;H_X&#39;, &#39;H_X&#39;, &#39;He_X&#39;, &#39;He_X&#39;, &#39;H_Y&#39;, &#39;H_Y&#39;, &#39;H_Y&#39;, &#39;He_Y&#39;, &#39;He_Y&#39; ... Z-axis]</span>
        <span class="c1"># I think this is easier to understand than using nested list comprehension</span>
        <span class="c1"># see https://stackabuse.com/python-how-to-flatten-list-of-lists/</span>
        <span class="n">full_df_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">full_df_columns</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">full_df_columns</span><span class="p">)</span>
        <span class="c1"># Save it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Hierarchical DataFrame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_dataframe</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;velocity_distribution&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">(</span><span class="s2">&quot;Velocity distribution calculation&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">time_division</span><span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tinit</span><span class="p">))</span></div>

<div class="viewcode-block" id="VelocityDistribution.compute_moments"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.VelocityDistribution.compute_moments">[docs]</a>    <span class="k">def</span> <span class="nf">compute_moments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parse_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vel_raw</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate and save moments of the distribution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parse_data: bool</span>
<span class="sd">            Flag for reading data. Default = False. If False, must pass ``vel_raw`` and ``time.</span>
<span class="sd">            If True it will parse data from simulations dumps.</span>

<span class="sd">        vel_raw: np.ndarray, optional</span>
<span class="sd">            Container of particles velocity at each time step.</span>

<span class="sd">        time: np.ndarray, optional</span>
<span class="sd">            Time array.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moments_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moments_hdf_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">parse_data</span><span class="p">:</span>
            <span class="n">time</span><span class="p">,</span> <span class="n">vel_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grab_sim_data</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">moments_dataframe</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating velocity moments ...&quot;</span><span class="p">)</span>
        <span class="n">tinit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="n">moments</span><span class="p">,</span> <span class="n">ratios</span> <span class="o">=</span> <span class="n">calc_moments</span><span class="p">(</span><span class="n">vel_raw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_no_moment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_index_start</span><span class="p">)</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">(</span><span class="s2">&quot;Velocity moments calculation&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">time_division</span><span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tinit</span><span class="p">))</span>

        <span class="c1"># Save the dataframe</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensional_average</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">moments_hdf_dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_X_Time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">time</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_no_moment</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">moments_dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> moment&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">moments</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">m</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">moments_hdf_dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_X_</span><span class="si">{}</span><span class="s2"> moment&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">moments</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">m</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_no_moment</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">moments_dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> moment ratio&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ratios</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">m</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">moments_hdf_dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_X_</span><span class="si">{}</span><span class="s2">-2 ratio&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ratios</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">m</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">moments_hdf_dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_Time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ds</span><span class="p">)]</span> <span class="o">=</span> <span class="n">time</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_no_moment</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">moments_dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> moment axis </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ds</span><span class="p">)]</span> <span class="o">=</span> <span class="n">moments</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">moments_hdf_dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2"> moment&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">moments</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">m</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">moments_hdf_dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_Time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ds</span><span class="p">)]</span> <span class="o">=</span> <span class="n">time</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_no_moment</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">moments_dataframe</span><span class="p">[</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> moment ratio axis </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ds</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ratios</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">moments_hdf_dataframe</span><span class="p">[</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">-2 ratio &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ratios</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">moments_dataframe</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="c1"># Hierarchical DF Save</span>
        <span class="c1"># Make the columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moments_hdf_dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments_hdf_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="c1"># Save the df in the hierarchical df with a new key/group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moments_hdf_dataframe</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s1">&#39;velocity_moments&#39;</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="VelocityDistribution.compute_hermite_expansion"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.VelocityDistribution.compute_hermite_expansion">[docs]</a>    <span class="k">def</span> <span class="nf">compute_hermite_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calc_moments</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate and save Hermite coefficients of the Grad expansion.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        calc_moments: bool</span>
<span class="sd">            Flag for calculating velocity moments. These are needed for the hermite calculation.</span>
<span class="sd">            Default = False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hermite_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hermite_hdf_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">calc_moments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_moments</span><span class="p">(</span><span class="n">parse_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;hermite_rms_tol&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hermite_rms_tol</span> <span class="o">=</span> <span class="mf">0.05</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hermite_dataframe</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moments_dataframe</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hermite_sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hermite_dataframe</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hermite_epochs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hermite_dataframe</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">])))</span>
        <span class="n">hermite_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_hermite_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hermite_dataframe</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">])))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating Hermite coefficients ...&quot;</span><span class="p">)</span>
        <span class="n">tinit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Species&#39;</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hermite_dataframe</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">],</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">)):</span>
                <span class="c1"># Grab the thermal speed from the moments</span>
                <span class="n">vrms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments_dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> 2 moment&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">)]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
                <span class="c1"># Loop over dimensions. No tensor availability yet</span>
                <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">]):</span>

                    <span class="c1"># Grab the distribution from the hierarchical df</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_dataframe</span><span class="p">[</span><span class="n">sp_name</span><span class="p">][</span><span class="n">ds</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>

                    <span class="c1"># Grab and center the bins</span>
                    <span class="n">v_bins</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_bin_edges</span><span class="p">[</span><span class="n">sp_name</span><span class="p">][</span><span class="n">ds</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_bin_edges</span><span class="p">[</span><span class="n">sp_name</span><span class="p">][</span><span class="n">ds</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">cntrl</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="c1"># This is a routine to calculate the hermite coefficient in the case of non-equilibrium simulations.</span>
                    <span class="c1"># In non-equilibrium we cannot define a temperature. This is because the temperature is defined from</span>
                    <span class="c1"># the rms width of a Gaussian distribution. In non-equilibrium we don&#39;t have a Gaussian, thus the</span>
                    <span class="c1"># first thing to do is to find the underlying Gaussian in our distribution. This is what this</span>
                    <span class="c1"># iterative procedure is for.</span>

                    <span class="k">while</span> <span class="n">cntrl</span><span class="p">:</span>
                        <span class="c1"># Normalize</span>
                        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">v_bins</span> <span class="o">/</span> <span class="n">vrms</span><span class="p">)</span>

                        <span class="c1"># Calculate the hermite coeff</span>
                        <span class="n">h_coeff</span> <span class="o">=</span> <span class="n">calculate_herm_coeff</span><span class="p">(</span><span class="n">v_bins</span> <span class="o">/</span> <span class="n">vrms</span><span class="p">,</span> <span class="n">dist</span> <span class="o">/</span> <span class="n">norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_hermite_order</span><span class="p">)</span>

                        <span class="c1"># Fit the rms only to the Grad expansion. This finds the underlying Gaussian</span>
                        <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span>
                            <span class="c1"># the lambda func is because i need to fit only rms not the h_coeff</span>
                            <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">rms</span><span class="p">:</span> <span class="n">grad_expansion</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">h_coeff</span><span class="p">),</span>
                            <span class="n">v_bins</span> <span class="o">/</span> <span class="n">vrms</span><span class="p">,</span>
                            <span class="n">dist</span> <span class="o">/</span> <span class="n">norm</span><span class="p">,</span>
                            <span class="n">maxfev</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>  <span class="c1"># TODO: let the user pass curve_fit arguments.</span>

                        <span class="n">vrms</span> <span class="o">*=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hermite_rms_tol</span><span class="p">:</span>
                            <span class="n">cntrl</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">hermite_sigmas</span><span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">vrms</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">hermite_epochs</span><span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                            <span class="n">hermite_coeff</span><span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">:,</span> <span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_coeff</span>
                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_hermite_order</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hermite_dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> Hermite coeff&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">h</span><span class="p">)]</span> <span class="o">=</span> <span class="n">hermite_coeff</span><span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hermite_hdf_dataframe</span><span class="p">[</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_Time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">h</span><span class="p">)]</span> <span class="o">=</span> <span class="n">hermite_coeff</span><span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hermite_hdf_dataframe</span><span class="p">[</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_RMS&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">h</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hermite_sigmas</span><span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hermite_hdf_dataframe</span><span class="p">[</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_epoch&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">h</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hermite_epochs</span><span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hermite_hdf_dataframe</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2"> coeff&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">h</span><span class="p">)]</span> <span class="o">=</span> <span class="n">hermite_coeff</span><span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Save the CSV</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hermite_dataframe</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">herm_df_filename_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="c1"># Make the columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hermite_hdf_dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hermite_hdf_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="c1"># Save the df in the hierarchical df with a new key/group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hermite_hdf_dataframe</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s1">&#39;hermite_coefficients&#39;</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">(</span><span class="s2">&quot;Hermite expansion calculation&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">time_division</span><span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tinit</span><span class="p">))</span></div>

<div class="viewcode-block" id="VelocityDistribution.pretty_print"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.VelocityDistribution.pretty_print">[docs]</a>    <span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print information in a user-friendly way.&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="si">{:=^70}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__long_name__</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CSV dataframe saved in:</span><span class="se">\n\t</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename_csv</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;HDF5 dataframe saved in:</span><span class="se">\n\t</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename_hdf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data accessible at: self.dataframe, self.hierarchical_dataframe, self.species_bin_edges&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Multi run average: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_run_average</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No. of runs: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Size of the parsed velocity array: </span><span class="si">{}</span><span class="s2"> x </span><span class="si">{}</span><span class="s2"> x </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_dumps</span><span class="p">,</span>
                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">runs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_dim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_num_ptcls</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Histograms Information:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">dics</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_hist_kwargs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">sp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Species: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Species: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No. of samples = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_num</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_dim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Thermal speed: v_th = </span><span class="si">{:.6e}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vth</span><span class="p">[</span><span class="n">sp</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[cm/s]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[m/s]&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">dics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> : ( </span><span class="si">{:.2f}</span><span class="s2">, </span><span class="si">{:.2f}</span><span class="s2"> ) v_th,&quot;</span>
                          <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">( </span><span class="si">{:.4e}</span><span class="s2">, </span><span class="si">{:.4e}</span><span class="s2"> ) &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">vth</span><span class="p">[</span><span class="n">sp</span><span class="p">],</span> <span class="o">*</span><span class="n">values</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[cm/s]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;cgs&quot;</span> <span class="k">else</span> <span class="s2">&quot;[m/s]&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
            <span class="n">bin_width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dics</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dics</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vth</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span> <span class="o">*</span> <span class="n">dics</span><span class="p">[</span><span class="s2">&quot;bins&quot;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bin Width = </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bin_width</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;max_no_moment&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Moments Information:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CSV dataframe saved in:</span><span class="se">\n\t</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mom_df_filename_csv</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data accessible at: self.moments_dataframe, self.moments_hdf_dataframe&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Highest moment to calculate: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_no_moment</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;max_hermite_order&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Grad Expansion Information:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CSV dataframe saved in:</span><span class="se">\n\t</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">herm_df_filename_csv</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data accessible at: self.hermite_dataframe, self.hermite_hdf_dataframe&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Highest order to calculate: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_hermite_order</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RMS Tolerance: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hermite_rms_tol</span><span class="p">))</span></div></div>


<span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">calc_Sk</span><span class="p">(</span><span class="n">nkt</span><span class="p">,</span> <span class="n">k_list</span><span class="p">,</span> <span class="n">k_counts</span><span class="p">,</span> <span class="n">species_np</span><span class="p">,</span> <span class="n">no_dumps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate :math:`S_{ij}(k)` at each saved timestep.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nkt : numpy.ndarray, complex</span>
<span class="sd">        Density fluctuations of all species. Shape = ( ``no_species``, ``no_dumps``, ``no_ka_values``)</span>

<span class="sd">    k_list :</span>
<span class="sd">        List of :math:`k` indices in each direction with corresponding magnitude and index of ``k_counts``.</span>
<span class="sd">        Shape=(``no_ka_values``, 5)</span>

<span class="sd">    k_counts : numpy.ndarray</span>
<span class="sd">        Number of times each :math:`k` magnitude appears.</span>

<span class="sd">    species_np : numpy.ndarray</span>
<span class="sd">        Array with number of particles of each species.</span>

<span class="sd">    no_dumps : int</span>
<span class="sd">        Number of dumps.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    Sk_all : numpy.ndarray</span>
<span class="sd">        Array containing :math:`S_{ij}(k)`. Shape=(``no_Sk``, ``no_ka_values``, ``no_dumps``)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">no_sk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species_np</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species_np</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">Sk_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">no_sk</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_counts</span><span class="p">),</span> <span class="n">no_dumps</span><span class="p">))</span>
    <span class="n">pair_indx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">si</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species_np</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">jp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_np</span><span class="p">)):</span>
            <span class="n">sj</span> <span class="o">=</span> <span class="n">species_np</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span>
            <span class="n">dens_const</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">si</span> <span class="o">*</span> <span class="n">sj</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_dumps</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">k_list</span><span class="p">):</span>
                    <span class="n">indx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ka</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">nk_i</span> <span class="o">=</span> <span class="n">nkt</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span>
                    <span class="n">nk_j</span> <span class="o">=</span> <span class="n">nkt</span><span class="p">[</span><span class="n">jp</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span>
                    <span class="n">Sk_raw</span><span class="p">[</span><span class="n">pair_indx</span><span class="p">,</span> <span class="n">indx</span><span class="p">,</span> <span class="n">it</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">nk_i</span><span class="p">)</span> <span class="o">*</span> <span class="n">nk_j</span><span class="p">)</span> <span class="o">*</span> <span class="n">dens_const</span> <span class="o">/</span> <span class="n">k_counts</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
            <span class="n">pair_indx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">Sk_raw</span>


<div class="viewcode-block" id="calc_Skw"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.calc_Skw">[docs]</a><span class="k">def</span> <span class="nf">calc_Skw</span><span class="p">(</span><span class="n">nkt</span><span class="p">,</span> <span class="n">ka_list</span><span class="p">,</span> <span class="n">species_np</span><span class="p">,</span> <span class="n">no_dumps</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dump_step</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Fourier transform of the correlation function of ``nkt``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dt : float</span>
<span class="sd">        Time interval.</span>

<span class="sd">    dump_step : int</span>
<span class="sd">        Snapshot interval.</span>

<span class="sd">    nkt :  complex, numpy.ndarray</span>
<span class="sd">        Particles&#39; density or velocity fluctuations.</span>
<span class="sd">        Shape = ( ``no_species``, ``no_dumps``, ``no_k_list``)</span>

<span class="sd">    ka_list : list</span>
<span class="sd">        List of :math:`k` indices in each direction with corresponding magnitude and index of ``ka_counts``.</span>
<span class="sd">        Shape=(``no_ka_values``, 5)</span>

<span class="sd">    ka_counts : numpy.ndarray</span>
<span class="sd">        Number of times each :math:`k` magnitude appears.</span>

<span class="sd">    species_np : numpy.ndarray</span>
<span class="sd">        Array with one element giving number of particles.</span>

<span class="sd">    no_dumps : int</span>
<span class="sd">        Number of dumps.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Skw : numpy.ndarray</span>
<span class="sd">        DSF/CCF of each species and pair of species.</span>
<span class="sd">        Shape = (``no_skw``, ``no_ka_values``, ``no_dumps``)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fourier transform normalization: norm = dt / Total time</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">no_dumps</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">dump_step</span><span class="p">)</span>
    <span class="c1"># number of independent observables</span>
    <span class="n">no_skw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species_np</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species_np</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># DSF</span>
    <span class="c1"># Skw = np.zeros((no_skw, len(ka_counts), no_dumps))</span>
    <span class="n">Skw_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">no_skw</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ka_list</span><span class="p">),</span> <span class="n">no_dumps</span><span class="p">))</span>
    <span class="n">pair_indx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">si</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species_np</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">jp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_np</span><span class="p">)):</span>
            <span class="n">sj</span> <span class="o">=</span> <span class="n">species_np</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span>
            <span class="n">dens_const</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">si</span> <span class="o">*</span> <span class="n">sj</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ka_list</span><span class="p">):</span>
                <span class="c1"># indx = int(ka[-1])</span>
                <span class="n">nkw_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">nkt</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="p">:,</span> <span class="n">ik</span><span class="p">])</span> <span class="o">*</span> <span class="n">norm</span>
                <span class="n">nkw_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">nkt</span><span class="p">[</span><span class="n">jp</span><span class="p">,</span> <span class="p">:,</span> <span class="n">ik</span><span class="p">])</span> <span class="o">*</span> <span class="n">norm</span>
                <span class="n">Skw_all</span><span class="p">[</span><span class="n">pair_indx</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">nkw_i</span><span class="p">)</span> <span class="o">*</span> <span class="n">nkw_j</span><span class="p">)</span> <span class="o">*</span> <span class="n">dens_const</span><span class="p">)</span>
                <span class="c1"># Skw[pair_indx, indx, :] += Skw_all[pair_indx, ik, :] / ka_counts[indx]</span>
            <span class="n">pair_indx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">Skw_all</span></div>


<span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">calc_elec_current</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">sp_charge</span><span class="p">,</span> <span class="n">sp_num</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the total electric current and electric current of each species.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vel: numpy.ndarray</span>
<span class="sd">        Particles&#39; velocities.</span>

<span class="sd">    sp_charge: numpy.ndarray</span>
<span class="sd">        Charge of each species.</span>

<span class="sd">    sp_num: numpy.ndarray</span>
<span class="sd">        Number of particles of each species.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Js : numpy.ndarray</span>
<span class="sd">        Electric current of each species. Shape = (``no_species``, ``no_dim``, ``no_dumps``)</span>

<span class="sd">    Jtot : numpy.ndarray</span>
<span class="sd">        Total electric current. Shape = (``no_dim``, ``no_dumps``)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_species</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp_num</span><span class="p">)</span>
    <span class="n">no_dumps</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">Js</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_species</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">no_dumps</span><span class="p">))</span>
    <span class="n">Jtot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">no_dumps</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_dumps</span><span class="p">):</span>
        <span class="n">sp_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sp_end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">q_sp</span><span class="p">,</span> <span class="n">n_sp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">num_species</span><span class="p">)),</span> <span class="n">sp_charge</span><span class="p">,</span> <span class="n">num_species</span><span class="p">):</span>
            <span class="c1"># Find the index of the last particle of species s</span>
            <span class="n">sp_end</span> <span class="o">+=</span> <span class="n">n_sp</span>
            <span class="c1"># Calculate the current of each species</span>
            <span class="n">Js</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_sp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="p">:,</span> <span class="n">sp_start</span><span class="p">:</span><span class="n">sp_end</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Add to the total current</span>
            <span class="n">Jtot</span><span class="p">[:,</span> <span class="n">it</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Js</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="n">it</span><span class="p">]</span>

            <span class="n">sp_start</span> <span class="o">+=</span> <span class="n">sp_end</span>

    <span class="k">return</span> <span class="n">Js</span><span class="p">,</span> <span class="n">Jtot</span>


<div class="viewcode-block" id="calc_moments"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.calc_moments">[docs]</a><span class="k">def</span> <span class="nf">calc_moments</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">max_moment</span><span class="p">,</span> <span class="n">species_index_start</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the moments of the (velocity) distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dist: numpy.ndarray</span>
<span class="sd">        Distribution of each time step. Shape = (``no_dumps``, ``dim``, ``runs * inv_dim * total_num_ptlcs``)</span>

<span class="sd">    max_moment: int</span>
<span class="sd">        Maximum moment to calculate</span>

<span class="sd">    species_index_start: numpy.ndarray</span>
<span class="sd">        Array containing the start index of each species. The last value is equivalent to dist.shape[-1]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    moments: numpy.ndarray</span>
<span class="sd">        Moments of the distribution.</span>
<span class="sd">        Shape=( ``no_species``, ``no_dumps``, ``dim``, ``max_moment`` )</span>

<span class="sd">    ratios: numpy.ndarray</span>
<span class="sd">        Ratios of each moments with respect to the expected Maxwellian value.</span>
<span class="sd">        Shape=( ``no_species``, ``no_dumps``,  ``no_dim``, ``max_moment - 1``)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    See these `equations &lt;https://en.wikipedia.org/wiki/Normal_distribution#Moments:~:text=distribution.-,Moments&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># from scipy.stats import moment as scp_moment</span>
    <span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">gamma</span> <span class="k">as</span> <span class="n">scp_gamma</span>

    <span class="n">no_species</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_index_start</span><span class="p">)</span>
    <span class="n">no_dumps</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">moments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">no_species</span><span class="p">,</span> <span class="n">no_dumps</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">max_moment</span><span class="p">))</span>
    <span class="n">ratios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">no_species</span><span class="p">,</span> <span class="n">no_dumps</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">max_moment</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">sp_start</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species_index_start</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="c1"># Calculate the correct start and end index for storage</span>
        <span class="n">sp_end</span> <span class="o">=</span> <span class="n">species_index_start</span><span class="p">[</span><span class="n">indx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">mom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_moment</span><span class="p">):</span>
            <span class="n">moments</span><span class="p">[</span><span class="n">indx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">mom</span><span class="p">]</span> <span class="o">=</span> <span class="n">scp_stats</span><span class="o">.</span><span class="n">moment</span><span class="p">(</span><span class="n">dist</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">sp_start</span><span class="p">:</span><span class="n">sp_end</span><span class="p">],</span> <span class="n">moment</span><span class="o">=</span><span class="n">mom</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># sqrt( &lt;v^2&gt; ) = standard deviation = moments[:, :, :, 1] ** (1/2)</span>
    <span class="k">for</span> <span class="n">mom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_moment</span><span class="p">):</span>
        <span class="n">pwr</span> <span class="o">=</span> <span class="n">mom</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">const</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">**</span> <span class="p">(</span><span class="n">pwr</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scp_gamma</span><span class="p">((</span><span class="n">pwr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">ratios</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">mom</span><span class="p">]</span> <span class="o">=</span> <span class="n">moments</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">mom</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">const</span> <span class="o">*</span> <span class="n">moments</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="n">pwr</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">moments</span><span class="p">,</span> <span class="n">ratios</span></div>


<span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">calc_nk</span><span class="p">(</span><span class="n">pos_data</span><span class="p">,</span> <span class="n">k_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the instantaneous microscopic density :math:`n(k)` defined as</span>

<span class="sd">    .. math::</span>
<span class="sd">        n_{A} ( k ) = \sum_i^{N_A} \exp [ -i \mathbf k \cdot \mathbf r_{i} ]</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos_data : numpy.ndarray</span>
<span class="sd">        Particles&#39; position scaled by the box lengths.</span>
<span class="sd">        Shape = ( ``no_dumps``, ``no_dim``, ``tot_no_ptcls``)</span>

<span class="sd">    k_list : list</span>
<span class="sd">        List of :math:`k` indices in each direction with corresponding magnitude and index of ``ka_counts``.</span>
<span class="sd">        Shape=(``no_ka_values``, 5)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nk : numpy.ndarray</span>
<span class="sd">        Array containing :math:`n(k)`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">k_vec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">k_list</span><span class="p">):</span>
        <span class="n">kr_i</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">k_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k_vec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">nk</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">kr_i</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">nk</span>


<div class="viewcode-block" id="calc_nkt"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.calc_nkt">[docs]</a><span class="k">def</span> <span class="nf">calc_nkt</span><span class="p">(</span><span class="n">fldr</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">dump_step</span><span class="p">,</span> <span class="n">species_np</span><span class="p">,</span> <span class="n">k_list</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate density fluctuations :math:`n(k,t)` of all species.</span>

<span class="sd">    .. math::</span>
<span class="sd">        n_{A} ( k, t ) = \sum_i^{N_A} \exp [ -i \mathbf k \cdot \mathbf r_{i}(t) ]</span>

<span class="sd">    where :math:`N_A` is the number of particles of species :math:`A`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fldr : str</span>
<span class="sd">        Name of folder containing particles data.</span>

<span class="sd">    slices : tuple, int</span>
<span class="sd">        Initial, final step number of the slice, total number of slice steps.</span>

<span class="sd">    dump_step : int</span>
<span class="sd">        Snapshot interval.</span>

<span class="sd">    species_np : numpy.ndarray</span>
<span class="sd">        Number of particles of each species.</span>

<span class="sd">    k_list : list</span>
<span class="sd">        List of :math: `k` vectors.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    nkt : numpy.ndarray, complex</span>
<span class="sd">        Density fluctuations.  Shape = ( ``no_species``, ``no_dumps``, ``no_ka_values``)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Read particles&#39; position for times in the slice</span>
    <span class="n">nkt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">species_np</span><span class="p">),</span> <span class="n">slices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">dump</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">slices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dump_step</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">)):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">load_from_restart</span><span class="p">(</span><span class="n">fldr</span><span class="p">,</span> <span class="n">dump</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span>
        <span class="n">sp_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sp_end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species_np</span><span class="p">):</span>
            <span class="n">sp_end</span> <span class="o">+=</span> <span class="n">sp</span>
            <span class="n">nkt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">calc_nk</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">sp_start</span><span class="p">:</span><span class="n">sp_end</span><span class="p">,</span> <span class="p">:],</span> <span class="n">k_list</span><span class="p">)</span>
            <span class="n">sp_start</span> <span class="o">+=</span> <span class="n">sp</span>

    <span class="k">return</span> <span class="n">nkt</span></div>


<span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">calc_pressure_tensor</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">species_mass</span><span class="p">,</span> <span class="n">species_np</span><span class="p">,</span> <span class="n">box_volume</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the pressure tensor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos : numpy.ndarray</span>
<span class="sd">        Particles&#39; positions.</span>

<span class="sd">    vel : numpy.ndarray</span>
<span class="sd">        Particles&#39; velocities.</span>

<span class="sd">    acc : numpy.ndarray</span>
<span class="sd">        Particles&#39; accelerations.</span>

<span class="sd">    species_mass : numpy.ndarray</span>
<span class="sd">        Mass of each species.</span>

<span class="sd">    species_np : numpy.ndarray</span>
<span class="sd">        Number of particles of each species.</span>

<span class="sd">    box_volume : float</span>
<span class="sd">        Volume of simulation&#39;s box.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pressure : float</span>
<span class="sd">        Scalar Pressure i.e. trace of the pressure tensor</span>

<span class="sd">    pressure_tensor : numpy.ndarray</span>
<span class="sd">        Pressure tensor. Shape(``no_dim``,``no_dim``)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sp_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sp_end</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Rescale vel and acc of each particle by their individual mass</span>
    <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species_np</span><span class="p">):</span>
        <span class="n">sp_end</span> <span class="o">+=</span> <span class="n">num</span>
        <span class="n">vel</span><span class="p">[:,</span> <span class="n">sp_start</span><span class="p">:</span> <span class="n">sp_end</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">species_mass</span><span class="p">[</span><span class="n">sp</span><span class="p">])</span>
        <span class="n">acc</span><span class="p">[:,</span> <span class="n">sp_start</span><span class="p">:</span> <span class="n">sp_end</span><span class="p">]</span> <span class="o">*=</span> <span class="n">species_mass</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span>  <span class="c1"># force</span>
        <span class="n">sp_start</span> <span class="o">+=</span> <span class="n">num</span>

    <span class="n">pressure_tensor</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">acc</span><span class="p">))</span> <span class="o">/</span> <span class="n">box_volume</span>
    <span class="n">pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">pressure_tensor</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span>

    <span class="k">return</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">pressure_tensor</span>


<span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">calc_statistical_efficiency</span><span class="p">(</span><span class="n">observable</span><span class="p">,</span> <span class="n">run_avg</span><span class="p">,</span> <span class="n">run_std</span><span class="p">,</span> <span class="n">max_no_divisions</span><span class="p">,</span> <span class="n">no_dumps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Todo:</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    observable</span>
<span class="sd">    run_avg</span>
<span class="sd">    run_std</span>
<span class="sd">    max_no_divisions</span>
<span class="sd">    no_dumps</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tau_blk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_no_divisions</span><span class="p">)</span>
    <span class="n">sigma2_blk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_no_divisions</span><span class="p">)</span>
    <span class="n">statistical_efficiency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_no_divisions</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_no_divisions</span><span class="p">):</span>
        <span class="n">tau_blk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">no_dumps</span> <span class="o">/</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">t_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">tau_blk</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">t_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau_blk</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">blk_avg</span> <span class="o">=</span> <span class="n">observable</span><span class="p">[</span><span class="n">t_start</span><span class="p">:</span><span class="n">t_end</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">sigma2_blk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">blk_avg</span> <span class="o">-</span> <span class="n">run_avg</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">sigma2_blk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">statistical_efficiency</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau_blk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigma2_blk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">run_std</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">tau_blk</span><span class="p">,</span> <span class="n">sigma2_blk</span><span class="p">,</span> <span class="n">statistical_efficiency</span>


<span class="c1"># @jit Numba doesn&#39;t like scipy.signal</span>
<div class="viewcode-block" id="calc_diff_flux_acf"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.calc_diff_flux_acf">[docs]</a><span class="k">def</span> <span class="nf">calc_diff_flux_acf</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">sp_num</span><span class="p">,</span> <span class="n">sp_dens</span><span class="p">,</span> <span class="n">sp_mass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the diffusion flux autocorrelation function of each species and in each direction.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vel : numpy.ndarray</span>
<span class="sd">        Particles&#39; velocities. Shape = (``dimensions``, ``no_dumps``, ``total_num_ptcls``)</span>

<span class="sd">    sp_num: numpy.ndarray</span>
<span class="sd">        Number of particles of each species.</span>

<span class="sd">    sp_dens: numpy.ndarray</span>
<span class="sd">        Number densities of each species.</span>

<span class="sd">    sp_mass: numpy.ndarray</span>
<span class="sd">        Particle&#39;s mass of each species.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    jc_acf: numpy.ndarray</span>
<span class="sd">        Diffusion flux autocorrelation function. Shape = ( Ns*(Ns +1)/2, Ndim + 1 , Nt)</span>
<span class="sd">        where Ns = number of species, Ndim = Number of cartesian dimensions, Nt = Number of dumps.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">no_dim</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">no_dumps</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">no_species</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp_num</span><span class="p">)</span>
    <span class="n">no_vacf</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">no_species</span> <span class="o">*</span> <span class="p">(</span><span class="n">no_species</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>

    <span class="n">mass_densities</span> <span class="o">=</span> <span class="n">sp_dens</span> <span class="o">*</span> <span class="n">sp_mass</span>
    <span class="n">tot_mass_dens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mass_densities</span><span class="p">)</span>
    <span class="c1"># Center of mass velocity field of each species in each direction and at each timestep</span>
    <span class="n">com_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">no_species</span><span class="p">,</span> <span class="n">no_dim</span><span class="p">,</span> <span class="n">no_dumps</span><span class="p">))</span>
    <span class="c1"># Total center of mass velocity field, see eq.(18) in</span>
    <span class="c1"># Haxhimali T. et al., Diffusivity of Mixtures in Warm Dense Matter Regime.In: Graziani F., et al. (eds)</span>
    <span class="c1"># Frontiers and Challenges in Warm Dense Matter. Lecture Notes in Computational Science and Engineering, vol 96.</span>
    <span class="c1"># Springer (2014)</span>
    <span class="n">tot_com_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">no_dim</span><span class="p">,</span> <span class="n">no_dumps</span><span class="p">))</span>

    <span class="n">sp_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sp_end</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Calculate the total center of mass velocity (tot_com_vel)</span>
    <span class="c1"># and the center of mass velocity of each species (com_vel)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ns</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sp_num</span><span class="p">):</span>
        <span class="n">sp_end</span> <span class="o">+=</span> <span class="n">ns</span>
        <span class="n">com_vel</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vel</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">sp_start</span><span class="p">:</span> <span class="n">sp_end</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tot_com_vel</span> <span class="o">+=</span> <span class="n">mass_densities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">com_vel</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">tot_mass_dens</span>
        <span class="n">sp_start</span> <span class="o">=</span> <span class="n">sp_end</span>

    <span class="n">jc_acf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">no_vacf</span><span class="p">,</span> <span class="n">no_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">no_dumps</span><span class="p">))</span>

    <span class="n">indx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># the flux is given by eq.(19) of the above reference</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rho1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mass_densities</span><span class="p">):</span>
        <span class="c1"># Flux of species i</span>
        <span class="n">sp1_flux</span> <span class="o">=</span> <span class="n">rho1</span> <span class="o">*</span> <span class="p">(</span><span class="n">com_vel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">tot_com_vel</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">rho2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mass_densities</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">i</span><span class="p">):</span>
            <span class="c1"># this sign seems to be an issue in the calculation of the flux</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">))</span>
            <span class="c1"># Flux of species j</span>
            <span class="n">sp2_flux</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">rho2</span> <span class="o">*</span> <span class="p">(</span><span class="n">com_vel</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">tot_com_vel</span><span class="p">)</span>
            <span class="c1"># Calculate the correlation function in each direction</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_dim</span><span class="p">):</span>
                <span class="c1"># Calculate the correlation function and add it to the array</span>
                <span class="n">jc_acf</span><span class="p">[</span><span class="n">indx</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">correlationfunction</span><span class="p">(</span><span class="n">sp1_flux</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="p">:],</span> <span class="n">sp2_flux</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="p">:])</span>
                <span class="c1"># Calculate the total correlation function by summing the three directions</span>
                <span class="n">jc_acf</span><span class="p">[</span><span class="n">indx</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">jc_acf</span><span class="p">[</span><span class="n">indx</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">indx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">jc_acf</span></div>


<span class="c1"># @jit Numba doesn&#39;t like Scipy</span>
<div class="viewcode-block" id="calc_vacf"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.calc_vacf">[docs]</a><span class="k">def</span> <span class="nf">calc_vacf</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">sp_num</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the velocity autocorrelation function of each species and in each direction.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vel : numpy.ndarray</span>
<span class="sd">        Particles&#39; velocities stored in a 3D array with shape = (D x Np x Nt).</span>
<span class="sd">        D = cartesian dimensions, Np = Number of particles, Nt = number of dumps.</span>

<span class="sd">    sp_num: numpy.ndarray</span>
<span class="sd">        Number of particles of each species.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vacf: numpy.ndarray</span>
<span class="sd">        Velocity autocorrelation functions. Shape= (No_species, D + 1, Nt)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">no_dim</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">no_dumps</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">vacf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sp_num</span><span class="p">),</span> <span class="n">no_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">no_dumps</span><span class="p">))</span>

    <span class="c1"># Calculate the vacf of each species in each dimension</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_dim</span><span class="p">):</span>
        <span class="n">sp_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sp_end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">n_sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sp_num</span><span class="p">):</span>
            <span class="n">sp_end</span> <span class="o">+=</span> <span class="n">n_sp</span>
            <span class="c1"># Temporary species vacf</span>
            <span class="n">sp_vacf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">no_dumps</span><span class="p">)</span>
            <span class="c1"># Calculate the vacf for each particle of species sp</span>
            <span class="k">for</span> <span class="n">ptcl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sp_start</span><span class="p">,</span> <span class="n">sp_end</span><span class="p">):</span>
                <span class="c1"># Calculate the correlation function and add it to the array</span>
                <span class="n">ptcl_vacf</span> <span class="o">=</span> <span class="n">correlationfunction</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ptcl</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vel</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ptcl</span><span class="p">,</span> <span class="p">:])</span>

                <span class="c1"># Add this particle vacf to the species vacf and normalize by the time origins</span>
                <span class="n">sp_vacf</span> <span class="o">+=</span> <span class="n">ptcl_vacf</span>

            <span class="c1"># Save the species vacf for dimension i</span>
            <span class="n">vacf</span><span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">sp_vacf</span> <span class="o">/</span> <span class="n">n_sp</span>
            <span class="c1"># Save the total vacf</span>
            <span class="n">vacf</span><span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">sp_vacf</span> <span class="o">/</span> <span class="n">n_sp</span>
            <span class="c1"># Move to the next species first particle position</span>
            <span class="n">sp_start</span> <span class="o">+=</span> <span class="n">n_sp</span>

    <span class="k">return</span> <span class="n">vacf</span></div>


<span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">calc_vk</span><span class="p">(</span><span class="n">pos_data</span><span class="p">,</span> <span class="n">vel_data</span><span class="p">,</span> <span class="n">k_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the instantaneous longitudinal and transverse velocity fluctuations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos_data : numpy.ndarray</span>
<span class="sd">        Particles&#39; position. Shape = ( ``no_dumps``, 3, ``tot_no_ptcls``)</span>

<span class="sd">    vel_data : numpy.ndarray</span>
<span class="sd">        Particles&#39; velocities. Shape = ( ``no_dumps``, 3, ``tot_no_ptcls``)</span>

<span class="sd">    k_list : list</span>
<span class="sd">        List of :math:`k` indices in each direction with corresponding magnitude and index of ``ka_counts``.</span>
<span class="sd">        Shape=(``no_ka_values``, 5)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vkt : numpy.ndarray</span>
<span class="sd">        Array containing longitudinal velocity fluctuations.</span>

<span class="sd">    vkt_i : numpy.ndarray</span>
<span class="sd">        Array containing transverse velocity fluctuations in the :math:`x` direction.</span>

<span class="sd">    vkt_j : numpy.ndarray</span>
<span class="sd">        Array containing transverse velocity fluctuations in the :math:`y` direction.</span>

<span class="sd">    vkt_k : numpy.ndarray</span>
<span class="sd">        Array containing transverse velocity fluctuations in the :math:`z` direction.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Longitudinal</span>
    <span class="n">vk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>

    <span class="c1"># Transverse</span>
    <span class="n">vk_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">vk_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">vk_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">k_vec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">k_list</span><span class="p">):</span>
        <span class="c1"># Calculate the dot product and cross product between k, r, and v</span>
        <span class="n">kr_i</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">k_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k_vec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">k_dot_v</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">k_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k_vec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="n">k_cross_v_i</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_vec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">k_cross_v_j</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_vec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">k_cross_v_k</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">vel_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Microscopic longitudinal current</span>
        <span class="n">vk</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k_dot_v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">kr_i</span><span class="p">))</span>
        <span class="c1"># Microscopic transverse current</span>
        <span class="n">vk_i</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k_cross_v_i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">kr_i</span><span class="p">))</span>
        <span class="n">vk_j</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k_cross_v_j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">kr_i</span><span class="p">))</span>
        <span class="n">vk_k</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k_cross_v_k</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">kr_i</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">vk</span><span class="p">,</span> <span class="n">vk_i</span><span class="p">,</span> <span class="n">vk_j</span><span class="p">,</span> <span class="n">vk_k</span>


<div class="viewcode-block" id="calc_vkt"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.calc_vkt">[docs]</a><span class="k">def</span> <span class="nf">calc_vkt</span><span class="p">(</span><span class="n">fldr</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">dump_step</span><span class="p">,</span> <span class="n">species_np</span><span class="p">,</span> <span class="n">k_list</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the longitudinal and transverse velocities fluctuations of all species.</span>
<span class="sd">    Longitudinal</span>

<span class="sd">    .. math::</span>
<span class="sd">        \lambda_A(\mathbf{k}, t) = \sum_i^{N_A} \mathbf{k} \cdot \mathbf{v}_{i}(t) \exp [ - i \mathbf{k} \cdot \mathbf{r}_{i}(t) ]</span>

<span class="sd">    Transverse</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\tau_A(\mathbf{k}, t) = \sum_i^{N_A} \mathbf{k} \\times \mathbf{v}_{i}(t) \exp [ - i \mathbf{k} \cdot \mathbf{r}_{i}(t) ]</span>

<span class="sd">    where :math:`N_A` is the number of particles of species :math:`A`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fldr : str</span>
<span class="sd">        Name of folder containing particles data.</span>

<span class="sd">    slices : tuple, int</span>
<span class="sd">        Initial, final step number of the slice, number of steps per slice.</span>

<span class="sd">    dump_step : int</span>
<span class="sd">        Timestep interval saving.</span>

<span class="sd">    species_np : numpy.ndarray</span>
<span class="sd">        Number of particles of each species.</span>

<span class="sd">    k_list : list</span>
<span class="sd">        List of :math: `k` vectors.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vkt : numpy.ndarray, complex</span>
<span class="sd">        Longitudinal velocity fluctuations.</span>
<span class="sd">        Shape = ( ``no_species``, ``no_dumps``, ``no_ka_values``)</span>

<span class="sd">    vkt_perp_i : numpy.ndarray, complex</span>
<span class="sd">        Transverse velocity fluctuations along the :math:`x` axis.</span>
<span class="sd">        Shape = ( ``no_species``, ``no_dumps``, ``no_ka_values``)</span>

<span class="sd">    vkt_perp_j : numpy.ndarray, complex</span>
<span class="sd">        Transverse velocity fluctuations along the :math:`y` axis.</span>
<span class="sd">        Shape = ( ``no_species``, ``no_dumps``, ``no_ka_values``)</span>

<span class="sd">    vkt_perp_k : numpy.ndarray, complex</span>
<span class="sd">        Transverse velocity fluctuations along the :math:`z` axis.</span>
<span class="sd">        Shape = ( ``no_species``, ``no_dumps``, ``no_ka_values``)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Read particles&#39; position for all times</span>
    <span class="n">no_dumps</span> <span class="o">=</span> <span class="n">slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">vkt_par</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">species_np</span><span class="p">),</span> <span class="n">no_dumps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">vkt_perp_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">species_np</span><span class="p">),</span> <span class="n">no_dumps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">vkt_perp_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">species_np</span><span class="p">),</span> <span class="n">no_dumps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">vkt_perp_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">species_np</span><span class="p">),</span> <span class="n">no_dumps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">dump</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">slices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dump_step</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">)):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">load_from_restart</span><span class="p">(</span><span class="n">fldr</span><span class="p">,</span> <span class="n">dump</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]</span>
        <span class="n">sp_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sp_end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species_np</span><span class="p">):</span>
            <span class="n">sp_end</span> <span class="o">+=</span> <span class="n">sp</span>
            <span class="n">vkt_par</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vkt_perp_i</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vkt_perp_j</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vkt_perp_k</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">calc_vk</span><span class="p">(</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">sp_start</span><span class="p">:</span><span class="n">sp_end</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vel</span><span class="p">[</span><span class="n">sp_start</span><span class="p">:</span><span class="n">sp_end</span><span class="p">],</span> <span class="n">k_list</span><span class="p">)</span>
            <span class="n">sp_start</span> <span class="o">+=</span> <span class="n">sp</span>

    <span class="k">return</span> <span class="n">vkt_par</span><span class="p">,</span> <span class="n">vkt_perp_i</span><span class="p">,</span> <span class="n">vkt_perp_j</span><span class="p">,</span> <span class="n">vkt_perp_k</span></div>


<div class="viewcode-block" id="grad_expansion"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.grad_expansion">[docs]</a><span class="k">def</span> <span class="nf">grad_expansion</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">h_coeff</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Grad expansion as given by eq.(5.97) in Liboff</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : numpy.ndarray</span>
<span class="sd">        Array of the scaled velocities</span>

<span class="sd">    rms : float</span>
<span class="sd">        RMS width of the Gaussian.</span>

<span class="sd">    h_coeff: numpy.ndarray</span>
<span class="sd">        Hermite coefficients withouth the division by factorial.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _ : numpy.ndarray</span>
<span class="sd">        Grad expansion.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gaussian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">rms</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rms</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">herm_coef</span> <span class="o">=</span> <span class="n">h_coeff</span> <span class="o">/</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h_coeff</span><span class="p">))]</span>
    <span class="n">hermite_series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">hermite_e</span><span class="o">.</span><span class="n">hermeval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">herm_coef</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gaussian</span> <span class="o">*</span> <span class="n">hermite_series</span></div>


<div class="viewcode-block" id="calculate_herm_coeff"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.calculate_herm_coeff">[docs]</a><span class="k">def</span> <span class="nf">calculate_herm_coeff</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">distribution</span><span class="p">,</span> <span class="n">maxpower</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Hermite coefficients by integrating the velocity distribution function. That is</span>

<span class="sd">    .. math::</span>
<span class="sd">        a_i = \int_{-\\infty}^{\infty} dv \, He_i(v)f(v)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    v : numpy.ndarray</span>
<span class="sd">        Range of velocities.</span>

<span class="sd">    distribution: numpy.ndarray</span>
<span class="sd">        Velocity histogram.</span>

<span class="sd">    maxpower: int</span>
<span class="sd">        Hermite order</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    coeff: numpy.ndarray</span>
<span class="sd">        Coefficients :math:`a_i`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxpower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">hc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">hc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Hp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">hermite_e</span><span class="o">.</span><span class="n">hermeval</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">hc</span><span class="p">)</span>
        <span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">distribution</span> <span class="o">*</span> <span class="n">Hp</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">coeff</span></div>


<div class="viewcode-block" id="kspace_setup"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.kspace_setup">[docs]</a><span class="k">def</span> <span class="nf">kspace_setup</span><span class="p">(</span><span class="n">box_lengths</span><span class="p">,</span> <span class="n">angle_averaging</span><span class="p">,</span> <span class="n">max_k_harmonics</span><span class="p">,</span> <span class="n">max_aa_harmonics</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate all allowed :math:`k` vectors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    max_k_harmonics : numpy.ndarray</span>
<span class="sd">        Number of harmonics in each direction.</span>

<span class="sd">    box_lengths : numpy.ndarray</span>
<span class="sd">        Length of each box&#39;s side.</span>

<span class="sd">    angle_averaging : str</span>
<span class="sd">        Flag for calculating all the possible `k` vector directions and magnitudes. Default = &#39;principal_axis&#39;</span>

<span class="sd">    max_aa_harmonics : numpy.ndarray</span>
<span class="sd">        Maximum `k` harmonics in each direction for angle average.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    k_arr : list</span>
<span class="sd">        List of all possible combination of :math:`(n_x, n_y, n_z)` with their corresponding magnitudes and indexes.</span>

<span class="sd">    k_counts : numpy.ndarray</span>
<span class="sd">        Number of occurrences of each triplet :math:`(n_x, n_y, n_z)` magnitude.</span>

<span class="sd">    k_unique : numpy.ndarray</span>
<span class="sd">        Magnitude of the unique allowed triplet :math:`(n_x, n_y, n_z)`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
        <span class="c1"># The first value of k_arr = [0, 0, 0]</span>
        <span class="n">first_non_zero</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Obtain all possible permutations of the wave number arrays</span>
        <span class="n">k_arr</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="o">/</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span> <span class="o">/</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span> <span class="o">/</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">harmonics</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;principal_axis&#39;</span><span class="p">:</span>
        <span class="c1"># The first value of k_arr = [1, 0, 0]</span>
        <span class="n">first_non_zero</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Calculate the k vectors along the principal axis only</span>
        <span class="n">k_arr</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="o">/</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">harmonics</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">k_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_arr</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">/</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
                          <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">harmonics</span><span class="p">,</span>
                              <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
                              <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">k_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_arr</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">/</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
                          <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">harmonics</span><span class="p">,</span>
                              <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
                              <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">angle_averaging</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
        <span class="c1"># The first value of k_arr = [0, 0, 0]</span>
        <span class="n">first_non_zero</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Obtain all possible permutations of the wave number arrays up to max_aa_harmonics included</span>
        <span class="n">k_arr</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="o">/</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span> <span class="o">/</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span> <span class="o">/</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_aa_harmonics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_aa_harmonics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_aa_harmonics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="n">harmonics</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_aa_harmonics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_aa_harmonics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_aa_harmonics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="c1"># Append the rest of k values calculated from principal axis</span>
        <span class="n">k_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">k_arr</span><span class="p">,</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="o">/</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_aa_harmonics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">harmonics</span><span class="p">,</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_aa_harmonics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
            <span class="n">axis</span> <span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">k_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">k_arr</span><span class="p">,</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">/</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_aa_harmonics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">harmonics</span><span class="p">,</span>
                              <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_aa_harmonics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
                              <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">k_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">k_arr</span><span class="p">,</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">/</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_aa_harmonics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">harmonics</span><span class="p">,</span>
                              <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_aa_harmonics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_k_harmonics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
                              <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Compute wave number magnitude - don&#39;t use |k| (skipping first entry in k_arr)</span>
    <span class="c1"># The round off is needed to avoid ka value different beyond a certain significant digit. It will break other parts</span>
    <span class="c1"># of the code otherwise.</span>
    <span class="n">k_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">k_arr</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
    <span class="n">harm_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">harmonics</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">k_mag</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">k_mag</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">2.0e-5</span><span class="p">:</span>
            <span class="n">k_mag</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
    <span class="c1"># Add magnitude to wave number array</span>
    <span class="n">k_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">k_arr</span><span class="p">,</span> <span class="n">k_mag</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Add magnitude to wave number array</span>
    <span class="n">harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">harmonics</span><span class="p">,</span> <span class="n">harm_mag</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Sort from lowest to highest magnitude</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">k_arr</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">k_arr</span> <span class="o">=</span> <span class="n">k_arr</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
    <span class="n">harmonics</span> <span class="o">=</span> <span class="n">harmonics</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

    <span class="c1"># Count how many times a |k| value appears</span>
    <span class="n">k_unique</span><span class="p">,</span> <span class="n">k_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">k_arr</span><span class="p">[</span><span class="n">first_non_zero</span><span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Generate a 1D array containing index to be used in S array</span>
    <span class="n">k_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_counts</span><span class="p">)),</span> <span class="n">k_counts</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="c1"># Add index to k_array</span>
    <span class="n">k_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">k_arr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">first_non_zero</span><span class="p">):,</span> <span class="p">:],</span> <span class="n">k_index</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">harmonics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">harmonics</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">first_non_zero</span><span class="p">):,</span> <span class="p">:],</span> <span class="n">k_index</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">k_arr</span><span class="p">,</span> <span class="n">k_counts</span><span class="p">,</span> <span class="n">k_unique</span><span class="p">,</span> <span class="n">harmonics</span></div>


<div class="viewcode-block" id="load_from_restart"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.load_from_restart">[docs]</a><span class="k">def</span> <span class="nf">load_from_restart</span><span class="p">(</span><span class="n">fldr</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load particles&#39; data from dumps.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fldr : str</span>
<span class="sd">        Folder containing dumps.</span>

<span class="sd">    it : int</span>
<span class="sd">        Timestep to load.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data : dict</span>
<span class="sd">        Particles&#39; data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fldr</span><span class="p">,</span> <span class="s2">&quot;checkpoint_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.npz&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="plot_labels"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.plot_labels">[docs]</a><span class="k">def</span> <span class="nf">plot_labels</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">xlbl</span><span class="p">,</span> <span class="n">ylbl</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create plot labels with correct units and prefixes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xdata: numpy.ndarray</span>
<span class="sd">        X values.</span>

<span class="sd">    ydata: numpy.ndarray</span>
<span class="sd">        Y values.</span>

<span class="sd">    xlbl: str</span>
<span class="sd">        String of the X quantity.</span>

<span class="sd">    ylbl: str</span>
<span class="sd">        String of the Y quantity.</span>

<span class="sd">    units: str</span>
<span class="sd">        &#39;cgs&#39; or &#39;mks&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xmultiplier: float</span>
<span class="sd">        Scaling factor for X data.</span>

<span class="sd">    ymultiplier: float</span>
<span class="sd">        Scaling factor for Y data.</span>

<span class="sd">    xprefix: str</span>
<span class="sd">        Prefix for X units label</span>

<span class="sd">    yprefix: str</span>
<span class="sd">         Prefix for Y units label.</span>

<span class="sd">    xlabel: str</span>
<span class="sd">        X label units.</span>

<span class="sd">    ylabel: str</span>
<span class="sd">        Y label units.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">xdata</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">ydata</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">ydata</span>

    <span class="c1"># Find the correct Units</span>
    <span class="n">units_dict</span> <span class="o">=</span> <span class="n">UNITS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;cgs&#39;</span> <span class="k">else</span> <span class="n">UNITS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;cgs&#39;</span> <span class="ow">and</span> <span class="n">xlbl</span> <span class="o">==</span> <span class="s1">&#39;Length&#39;</span><span class="p">:</span>
        <span class="n">xmax</span> <span class="o">*=</span> <span class="mf">1e2</span>

    <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;cgs&#39;</span> <span class="ow">and</span> <span class="n">ylbl</span> <span class="o">==</span> <span class="s1">&#39;Length&#39;</span><span class="p">:</span>
        <span class="n">ymax</span> <span class="o">*=</span> <span class="mf">1e2</span>

    <span class="c1"># Use scientific notation. This returns a string</span>
    <span class="n">x_str</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">format_float_scientific</span><span class="p">(</span><span class="n">xmax</span><span class="p">)</span>
    <span class="n">y_str</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">format_float_scientific</span><span class="p">(</span><span class="n">ymax</span><span class="p">)</span>

    <span class="c1"># Grab the exponent</span>
    <span class="n">x_exp</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x_str</span><span class="p">[</span><span class="n">x_str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]))</span>
    <span class="n">y_exp</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y_str</span><span class="p">[</span><span class="n">y_str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]))</span>

    <span class="c1"># Find the units&#39; prefix by looping over the possible values</span>
    <span class="n">xprefix</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
    <span class="n">xmul</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span>
    <span class="c1"># This is a 10 multiplier</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">while</span> <span class="n">xmul</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">PREFIXES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">x_exp</span> <span class="o">/</span> <span class="n">value</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0e-6</span><span class="p">:</span>
                <span class="n">xprefix</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">xmul</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">value</span>
        <span class="n">i</span> <span class="o">/=</span> <span class="mi">10</span>
    <span class="c1"># find the prefix</span>
    <span class="n">yprefix</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
    <span class="n">ymul</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">1.5</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">while</span> <span class="n">ymul</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">PREFIXES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">y_exp</span> <span class="o">/</span> <span class="n">value</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0e-6</span><span class="p">:</span>
                <span class="n">yprefix</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">ymul</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">value</span>
        <span class="n">i</span> <span class="o">/=</span> <span class="mf">10.</span>

    <span class="k">if</span> <span class="s2">&quot;Energy&quot;</span> <span class="ow">in</span> <span class="n">ylbl</span><span class="p">:</span>
        <span class="n">yname</span> <span class="o">=</span> <span class="s2">&quot;Energy&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">yname</span> <span class="o">=</span> <span class="n">ylbl</span>

    <span class="k">if</span> <span class="s2">&quot;Pressure&quot;</span> <span class="ow">in</span> <span class="n">ylbl</span><span class="p">:</span>
        <span class="n">yname</span> <span class="o">=</span> <span class="s2">&quot;Pressure&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">yname</span> <span class="o">=</span> <span class="n">ylbl</span>

    <span class="k">if</span> <span class="n">yname</span> <span class="ow">in</span> <span class="n">units_dict</span><span class="p">:</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="n">yprefix</span> <span class="o">+</span> <span class="n">units_dict</span><span class="p">[</span><span class="n">yname</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="s2">&quot;Energy&quot;</span> <span class="ow">in</span> <span class="n">xlbl</span><span class="p">:</span>
        <span class="n">xname</span> <span class="o">=</span> <span class="s2">&quot;Energy&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xname</span> <span class="o">=</span> <span class="n">xlbl</span>

    <span class="k">if</span> <span class="s2">&quot;Pressure&quot;</span> <span class="ow">in</span> <span class="n">xlbl</span><span class="p">:</span>
        <span class="n">xname</span> <span class="o">=</span> <span class="s2">&quot;Pressure&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xname</span> <span class="o">=</span> <span class="n">xlbl</span>

    <span class="k">if</span> <span class="n">xname</span> <span class="ow">in</span> <span class="n">units_dict</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="n">xprefix</span> <span class="o">+</span> <span class="n">units_dict</span><span class="p">[</span><span class="n">xname</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">return</span> <span class="n">xmul</span><span class="p">,</span> <span class="n">ymul</span><span class="p">,</span> <span class="n">xprefix</span><span class="p">,</span> <span class="n">yprefix</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span></div>


<div class="viewcode-block" id="correlationfunction"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.correlationfunction">[docs]</a><span class="k">def</span> <span class="nf">correlationfunction</span><span class="p">(</span><span class="n">At</span><span class="p">,</span> <span class="n">Bt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the correlation function :math:`\mathbf{A}(t)` and :math:`\mathbf{B}(t)` using</span>
<span class="sd">    ``scipy.signal.correlate``</span>

<span class="sd">    .. math::</span>
<span class="sd">        C_{AB}(\\tau) =  \sum_j^D \sum_i^T A_j(t_i)B_j(t_i + \\tau)</span>

<span class="sd">    where :math:`D` (= ``no_dim``) is the number of dimensions and :math:`T` (= ``no_steps``) is the total length</span>
<span class="sd">    of the simulation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    At : numpy.ndarray</span>
<span class="sd">        Observable to correlate. Shape=(``no_steps``).</span>

<span class="sd">    Bt : numpy.ndarray</span>
<span class="sd">        Observable to correlate. Shape=(``no_steps``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CF : numpy.ndarray</span>
<span class="sd">        Correlation function :math:`C_{AB}(\\tau)`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">no_steps</span> <span class="o">=</span> <span class="n">At</span><span class="o">.</span><span class="n">size</span>

    <span class="c1"># Calculate the full correlation function.</span>
    <span class="n">full_corr</span> <span class="o">=</span> <span class="n">scp_signal</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">At</span><span class="p">,</span> <span class="n">Bt</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
    <span class="c1"># Normalization of the full correlation function, Similar to norm_counter</span>
    <span class="n">norm_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">no_steps</span> <span class="o">-</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_steps</span><span class="p">)])</span>
    <span class="c1"># Find the mid point of the array</span>
    <span class="n">mid</span> <span class="o">=</span> <span class="n">full_corr</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="c1"># I want only the second half of the array, i.e. the positive lags only</span>
    <span class="k">return</span> <span class="n">full_corr</span><span class="p">[</span><span class="n">mid</span><span class="p">:]</span> <span class="o">/</span> <span class="n">norm_corr</span></div>


<div class="viewcode-block" id="col_mapper"><a class="viewcode-back" href="../../../api/sarkas.tools.observables.html#sarkas.tools.observables.col_mapper">[docs]</a><span class="k">def</span> <span class="nf">col_mapper</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">))</span></div>

<span class="c1"># These are old functions that should not be trusted.</span>
<span class="c1"># @njit</span>
<span class="c1"># def autocorrelationfunction_slow(At):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Calculate the autocorrelation function of the array input.</span>
<span class="c1">#</span>
<span class="c1">#     .. math::</span>
<span class="c1">#         A(\\tau) =  \sum_j^D \sum_i^T A_j(t_i)A_j(t_i + \\tau)</span>
<span class="c1">#</span>
<span class="c1">#     where :math:`D` is the number of dimensions and :math:`T` is the total length</span>
<span class="c1">#     of the simulation.</span>
<span class="c1">#</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     At : numpy.ndarray</span>
<span class="c1">#         Observable to autocorrelate. Shape=(``no_dim``, ``no_steps``).</span>
<span class="c1">#</span>
<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     ACF : numpy.ndarray</span>
<span class="c1">#         Autocorrelation function of ``At``.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     no_steps = At.shape[1]</span>
<span class="c1">#     no_dim = At.shape[0]</span>
<span class="c1">#</span>
<span class="c1">#     ACF = np.zeros(no_steps)</span>
<span class="c1">#     Norm_counter = np.zeros(no_steps)</span>
<span class="c1">#</span>
<span class="c1">#     for it in range(no_steps):</span>
<span class="c1">#         for dim in range(no_dim):</span>
<span class="c1">#             ACF[: no_steps - it] += At[dim, it] * At[dim, it:no_steps]</span>
<span class="c1">#         Norm_counter[: no_steps - it] += 1.0</span>
<span class="c1">#</span>
<span class="c1">#     return ACF / Norm_counter</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># @njit</span>
<span class="c1"># def autocorrelationfunction_1D_slow(At):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Calculate the autocorrelation function of the input.</span>
<span class="c1">#</span>
<span class="c1">#     .. math::</span>
<span class="c1">#         A(\\tau) =  \sum_i^T A(t_i)A(t_i + \\tau)</span>
<span class="c1">#</span>
<span class="c1">#     where :math:`T` is the total length of the simulation.</span>
<span class="c1">#</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     At : numpy.ndarray</span>
<span class="c1">#         Array to autocorrelate. Shape=(``no_steps``).</span>
<span class="c1">#</span>
<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     ACF : numpy.ndarray</span>
<span class="c1">#         Autocorrelation function of ``At``.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     no_steps = At.shape[0]</span>
<span class="c1">#     ACF = np.zeros(no_steps)</span>
<span class="c1">#     Norm_counter = np.zeros(no_steps)</span>
<span class="c1">#</span>
<span class="c1">#     for it in range(no_steps):</span>
<span class="c1">#         ACF[: no_steps - it] += At[it] * At[it:no_steps]</span>
<span class="c1">#         Norm_counter[: no_steps - it] += 1.0</span>
<span class="c1">#</span>
<span class="c1">#     return ACF / Norm_counter</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># @jit</span>
<span class="c1"># def autocorrelationfunction(At):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Calculate the autocorrelation function of the array input.</span>
<span class="c1">#</span>
<span class="c1">#     .. math::</span>
<span class="c1">#         A(\\tau) =  \sum_j^D \sum_i^T A_j(t_i)A_j(t_i + \\tau)</span>
<span class="c1">#</span>
<span class="c1">#     where :math:`D` is the number of dimensions and :math:`T` is the total length</span>
<span class="c1">#     of the simulation.</span>
<span class="c1">#</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     At : numpy.ndarray</span>
<span class="c1">#         Observable to autocorrelate. Shape=(``no_dim``, ``no_steps``).</span>
<span class="c1">#</span>
<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     ACF : numpy.ndarray</span>
<span class="c1">#         Autocorrelation function of ``At``.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     no_steps = At.shape[1]</span>
<span class="c1">#     no_dim = At.shape[0]</span>
<span class="c1">#</span>
<span class="c1">#     norm_counter = np.zeros(no_steps)</span>
<span class="c1">#     # Number of time origins for each time step</span>
<span class="c1">#     for it in range(no_steps):</span>
<span class="c1">#         norm_counter[: no_steps - it] += 1.0</span>
<span class="c1">#</span>
<span class="c1">#     ACF_total = np.zeros(no_steps)</span>
<span class="c1">#     for i in range(no_dim):</span>
<span class="c1">#         At2 = np.zeros(int(2 * no_steps), dtype=np.complex128)</span>
<span class="c1">#         At2[:no_steps] = At[i, :] + 1j * 0.0</span>
<span class="c1">#         # Prepare for FFTW</span>
<span class="c1">#         fftw_obj = pyfftw.builders.fft(At2)</span>
<span class="c1">#         # Calculate FFTW</span>
<span class="c1">#         Aw = fftw_obj()</span>
<span class="c1">#         # ACF in frequency space</span>
<span class="c1">#         Aw2 = np.conj(Aw) * Aw</span>
<span class="c1">#         # Prepare for IFFTW</span>
<span class="c1">#         ifftw_obj = pyfftw.builders.ifft(Aw2)</span>
<span class="c1">#         # IFFTW to get ACF</span>
<span class="c1">#         At2 = ifftw_obj()</span>
<span class="c1">#         # Normalization associated with FFTW</span>
<span class="c1">#         # At2 /= 2 * no_steps</span>
<span class="c1">#         ACF_total += np.real(At2[:no_steps]) / norm_counter</span>
<span class="c1">#</span>
<span class="c1">#     return ACF_total</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># @jit</span>
<span class="c1"># def autocorrelationfunction_1D(At):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Calculate the autocorrelation function of the input using the FFT method.</span>
<span class="c1">#</span>
<span class="c1">#     .. math::</span>
<span class="c1">#         A(\\tau) =  \sum_i^T A(t_i)A(t_i + \\tau)</span>
<span class="c1">#</span>
<span class="c1">#     where :math:`T` is the total length of the simulation.</span>
<span class="c1">#</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     At : numpy.ndarray</span>
<span class="c1">#         Array to autocorrelate. Shape=(``no_steps``).</span>
<span class="c1">#</span>
<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     ACF : numpy.ndarray</span>
<span class="c1">#         Autocorrelation function of ``At``.</span>
<span class="c1">#</span>
<span class="c1">#     Notes</span>
<span class="c1">#     -----</span>
<span class="c1">#     This code is a reproduction of Allen-Tildesley</span>
<span class="c1">#     `code &lt;https://github.com/Allen-Tildesley/examples/blob/master/python_examples/corfun.py&gt;`_</span>
<span class="c1">#</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     no_steps = At.shape[0]</span>
<span class="c1">#     # Normalization. Number of time origins for each time step</span>
<span class="c1">#     norm_counter = np.zeros(no_steps)</span>
<span class="c1">#     for it in range(no_steps):</span>
<span class="c1">#         norm_counter[: no_steps - it] += 1.0</span>
<span class="c1">#</span>
<span class="c1">#     # Create the arrays for FFTW</span>
<span class="c1">#     At2 = pyfftw.empty_aligned(int(2 * no_steps), dtype=np.complex128)</span>
<span class="c1">#     Aw = pyfftw.empty_aligned(int(2 * no_steps), dtype=np.complex128)</span>
<span class="c1">#     # Append an array of zeros to the function A(t)</span>
<span class="c1">#     At2[:no_steps] = At + 1j * 0.0</span>
<span class="c1">#     # Prepare for FFTW</span>
<span class="c1">#     fftw_obj = pyfftw.builders.fft(At2, Aw)</span>
<span class="c1">#     # Calculate FFTW</span>
<span class="c1">#     Aw = fftw_obj()</span>
<span class="c1">#     # ACF in frequency space</span>
<span class="c1">#     Aw2 = np.conj(Aw) * Aw</span>
<span class="c1">#     # Prepare for IFFTW, Aw2 At2 is the out_array</span>
<span class="c1">#     ifftw_obj = pyfftw.builders.fft(Aw2, At2)</span>
<span class="c1">#     # IFFTW to get ACF</span>
<span class="c1">#     At2 = ifftw_obj()</span>
<span class="c1">#     return np.real(At2[:no_steps]) / norm_counter</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># @njit</span>

<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># @njit</span>
<span class="c1"># def correlationfunction_1D_slow(At, Bt):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Calculate the correlation function between :math:`A(t)` and :math:`B(t)`</span>
<span class="c1">#</span>
<span class="c1">#     .. math::</span>
<span class="c1">#         C_{AB}(\\tau) =  \sum_i^T A(t_i)B(t_i + \\tau)</span>
<span class="c1">#</span>
<span class="c1">#     where :math:`T` (= ``no_steps``) is the total length of the simulation.</span>
<span class="c1">#</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     At : numpy.ndarray</span>
<span class="c1">#         Observable to correlate. Shape=(``no_steps``).</span>
<span class="c1">#</span>
<span class="c1">#     Bt : numpy.ndarray</span>
<span class="c1">#         Observable to correlate. Shape=(``no_steps``).</span>
<span class="c1">#</span>
<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     CF : numpy.ndarray</span>
<span class="c1">#         Correlation function :math:`C_{AB}(\\tau)`</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     no_steps = At.shape[0]</span>
<span class="c1">#     CF = np.zeros(no_steps)</span>
<span class="c1">#     Norm_counter = np.zeros(no_steps)</span>
<span class="c1">#</span>
<span class="c1">#     for it in range(no_steps):</span>
<span class="c1">#         CF[: no_steps - it] += At[it] * Bt[it:no_steps]</span>
<span class="c1">#         Norm_counter[: no_steps - it] += 1.0</span>
<span class="c1">#</span>
<span class="c1">#     return CF / Norm_counter</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># @jit</span>
<span class="c1"># def correlationfunction(At, Bt):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Calculate the autocorrelation function of the array input.</span>
<span class="c1">#</span>
<span class="c1">#     .. math::</span>
<span class="c1">#         A(\\tau) =  \sum_j^D \sum_i^T A_j(t_i)A_j(t_i + \\tau)</span>
<span class="c1">#</span>
<span class="c1">#     where :math:`D` is the number of dimensions and :math:`T` is the total length</span>
<span class="c1">#     of the simulation.</span>
<span class="c1">#</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     At : numpy.ndarray</span>
<span class="c1">#         Observable to autocorrelate. Shape=(``no_dim``, ``no_steps``).</span>
<span class="c1">#</span>
<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     ACF : numpy.ndarray</span>
<span class="c1">#         Autocorrelation function of ``At``.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     no_steps = At.shape[1]</span>
<span class="c1">#     no_dim = At.shape[0]</span>
<span class="c1">#</span>
<span class="c1">#     norm_counter = np.zeros(no_steps)</span>
<span class="c1">#     # Number of time origins for each time step</span>
<span class="c1">#     for it in range(no_steps):</span>
<span class="c1">#         norm_counter[: no_steps - it] += 1.0</span>
<span class="c1">#</span>
<span class="c1">#     CF_total = np.zeros(no_steps)</span>
<span class="c1">#     for i in range(no_dim):</span>
<span class="c1">#         # Create a larger array for storing A(t)</span>
<span class="c1">#         At2 = np.zeros(int(2 * no_steps), dtype=np.complex128)</span>
<span class="c1">#         At2[:no_steps] = At[i, :] + 1j * 0.0</span>
<span class="c1">#         # Create a larger array for storing B(t)</span>
<span class="c1">#         Bt2 = np.zeros(int(2 * no_steps), dtype=np.complex128)</span>
<span class="c1">#         Bt2[:no_steps] = Bt[i, :] + 1j * 0.0</span>
<span class="c1">#         # Prepare for FFTW</span>
<span class="c1">#         A_fftw_obj = pyfftw.builders.fft(At2)</span>
<span class="c1">#         # Calculate FFTW</span>
<span class="c1">#         Aw = A_fftw_obj()</span>
<span class="c1">#         # Prepare for B FFTW</span>
<span class="c1">#         B_fftw_obj = pyfftw.builders.fft(Bt2)</span>
<span class="c1">#         # Calculate FFTW</span>
<span class="c1">#         Bw = B_fftw_obj()</span>
<span class="c1">#         # ACF in frequency space</span>
<span class="c1">#         CFw2 = np.conj(Aw) * Bw</span>
<span class="c1">#         # Prepare for IFFTW</span>
<span class="c1">#         ifftw_obj = pyfftw.builders.ifft(CFw2)</span>
<span class="c1">#         # IFFTW to get ACF</span>
<span class="c1">#         CF_t = ifftw_obj()</span>
<span class="c1">#</span>
<span class="c1">#         # Normalization associated with FFTW</span>
<span class="c1">#         # At2 /= 2 * no_steps</span>
<span class="c1">#         CF_total += np.real(CF_t[:no_steps]) / norm_counter</span>
<span class="c1">#</span>
<span class="c1">#     return CF_total</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># @jit</span>
<span class="c1"># def correlationfunction_1D(At, Bt):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Calculate the autocorrelation function of the input.</span>
<span class="c1">#</span>
<span class="c1">#     .. math::</span>
<span class="c1">#         A(\\tau) =  \sum_i^T A(t_i)A(t_i + \\tau)</span>
<span class="c1">#</span>
<span class="c1">#     where :math:`T` is the total length of the simulation.</span>
<span class="c1">#</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     At : numpy.ndarray</span>
<span class="c1">#         Array to autocorrelate. Shape=(``no_steps``).</span>
<span class="c1">#</span>
<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     ACF : numpy.ndarray</span>
<span class="c1">#         Autocorrelation function of ``At``.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     no_steps = At.shape[0]</span>
<span class="c1">#     norm_counter = np.zeros(no_steps)</span>
<span class="c1">#     # Create a larger array for storing A(t)</span>
<span class="c1">#     At2 = np.zeros(int(2 * no_steps), dtype=np.complex128)</span>
<span class="c1">#     At2[:no_steps] = At + 1j * 0.0</span>
<span class="c1">#     # Create a larger array for storing B(t)</span>
<span class="c1">#     Bt2 = np.zeros(int(2 * no_steps), dtype=np.complex128)</span>
<span class="c1">#     Bt2[:no_steps] = Bt + 1j * 0.0</span>
<span class="c1">#     # Prepare for FFTW</span>
<span class="c1">#     A_fftw_obj = pyfftw.builders.fft(At2)</span>
<span class="c1">#     # Calculate FFTW</span>
<span class="c1">#     Aw = A_fftw_obj()</span>
<span class="c1">#     # Prepare for B FFTW</span>
<span class="c1">#     B_fftw_obj = pyfftw.builders.fft(Bt2)</span>
<span class="c1">#     # Calculate FFTW</span>
<span class="c1">#     Bw = B_fftw_obj()</span>
<span class="c1">#</span>
<span class="c1">#     # ACF in frequency space</span>
<span class="c1">#     ACFw2 = np.conj(Aw) * Bw</span>
<span class="c1">#     # Prepare for IFFTW</span>
<span class="c1">#     ifftw_obj = pyfftw.builders.ifft(ACFw2)</span>
<span class="c1">#     # IFFTW to get ACF</span>
<span class="c1">#     CF_t = ifftw_obj()</span>
<span class="c1">#     # Normalization associated with FFTW</span>
<span class="c1">#     # At2 /= 2 * no_steps</span>
<span class="c1">#     # Number of time origins for each time step</span>
<span class="c1">#     for it in range(no_steps):</span>
<span class="c1">#         norm_counter[: no_steps - it] += 1.0</span>
<span class="c1">#</span>
<span class="c1">#     return np.real(CF_t[:no_steps]) / norm_counter</span>
</pre></div>

    </div>
      
  </div>
</div> 
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019-2021, MurilloGroup.<br/>
      Last updated on Apr 14, 2021.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.4.<br/>
    </p>
  </div>
</footer>

  <script type="text/javascript">
    jQuery(function () {
        SphinxRtdTheme.Navigation.enable(true);
      })
  </script>
  
  <style>
    /* Sidebar header (and topbar for mobile) */
    /* .wy-side-nav-search,  */
    .wy-nav-top {
      background: #18453b;
    }
    /* Sidebar */
    .wy-nav-side {
      background: #535054;
    }
    .wy-menu-vertical p.caption {
	  color: #fff;
	}
	.wy-menu-vertical a {
	  color: #eee;
	}
	.wy-menu-vertical a:hover {
    background-color: #18453b;
  }
 /* .wy-nav-content {
    max-width: 900px !important;
  } */
}
  </style>

  </body>
</html>